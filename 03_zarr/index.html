
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-6.2.5">
    
    
      
        <title>Saving with Zarr - Satip Documentation</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.15aa0b43.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.75751829.min.css">
        
          
          
          <meta name="theme-color" content="#000000">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="black" data-md-color-accent="">
      
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#zarr" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href=".." title="Satip Documentation" class="md-header-nav__button md-logo" aria-label="Satip Documentation">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      <div class="md-header-nav__ellipsis">
        <div class="md-header-nav__topic">
          <span class="md-ellipsis">
            Satip Documentation
          </span>
        </div>
        <div class="md-header-nav__topic">
          <span class="md-ellipsis">
            
              Saving with Zarr
            
          </span>
        </div>
      </div>
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/Future-Energy-Associates/satip/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    Future-Energy-Associates/satip
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href=".." class="md-tabs__link">
      Home
    </a>
  </li>

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../101_downloading/" class="md-tabs__link">
        User Guide
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../about/OCF/" class="md-tabs__link">
        About
      </a>
    </li>
  

      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="../00_utils/" class="md-tabs__link md-tabs__link--active">
        Development
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Satip Documentation" class="md-nav__button md-logo" aria-label="Satip Documentation">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Satip Documentation
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/Future-Energy-Associates/satip/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    Future-Energy-Associates/satip
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      


  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2" >
      
      <label class="md-nav__link" for="nav-2">
        User Guide
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="User Guide" data-md-level="1">
        <label class="md-nav__title" for="nav-2">
          <span class="md-nav__icon md-icon"></span>
          User Guide
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../101_downloading/" class="md-nav__link">
        Downloading from EUMETSAT
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../102_reprojecting/" class="md-nav__link">
        Reprojecting
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../103_loading/" class="md-nav__link">
        Loading from Zarr
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      


  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" >
      
      <label class="md-nav__link" for="nav-3">
        About
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="About" data-md-level="1">
        <label class="md-nav__title" for="nav-3">
          <span class="md-nav__icon md-icon"></span>
          About
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../about/OCF/" class="md-nav__link">
        OCF
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../about/Solar%20Forecasting/" class="md-nav__link">
        Solar Forecasting
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      


  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4" checked>
      
      <label class="md-nav__link" for="nav-4">
        Development
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Development" data-md-level="1">
        <label class="md-nav__title" for="nav-4">
          <span class="md-nav__icon md-icon"></span>
          Development
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../00_utils/" class="md-nav__link">
        Utilities
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../01_eumetsat/" class="md-nav__link">
        Downloading
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../02_reproj/" class="md-nav__link">
        Reprojection
      </a>
    </li>
  

          
            
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Saving with Zarr
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Saving with Zarr
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#user-inputs" class="md-nav__link">
    User Inputs
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#loading-environment-variables" class="md-nav__link">
    Loading Environment Variables
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#preparing-data-to-save-to-zarr" class="md-nav__link">
    Preparing Data to Save to Zarr
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#compressing" class="md-nav__link">
    Compressing
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#saving-to-zarr" class="md-nav__link">
    Saving to Zarr
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#loading-zarr-data" class="md-nav__link">
    Loading Zarr Data
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../04_gcp/" class="md-nav__link">
        GCP Analytics
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../05_pipeline/" class="md-nav__link">
        Pipelines
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#user-inputs" class="md-nav__link">
    User Inputs
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#loading-environment-variables" class="md-nav__link">
    Loading Environment Variables
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#preparing-data-to-save-to-zarr" class="md-nav__link">
    Preparing Data to Save to Zarr
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#compressing" class="md-nav__link">
    Compressing
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#saving-to-zarr" class="md-nav__link">
    Saving to Zarr
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#loading-zarr-data" class="md-nav__link">
    Loading Zarr Data
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/Future-Energy-Associates/satip/edit/master/docs/03_zarr.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="zarr">Zarr<a class="headerlink" href="#zarr" title="Permanent link">&para;</a></h1>
<div class="highlight"><pre><span></span><code>Downloading: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 1/1 [00:00&lt;00:00,  2.10rows/s]
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">dotenv</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">cartopy.crs</span> <span class="k">as</span> <span class="nn">ccrs</span>

<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">JSON</span>
</code></pre></div>
<p><br></p>
<h3 id="user-inputs">User Inputs<a class="headerlink" href="#user-inputs" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">data_dir</span> <span class="o">=</span> <span class="s1">&#39;../data/raw&#39;</span>
<span class="n">metadata_db_fp</span> <span class="o">=</span> <span class="s1">&#39;../data/EUMETSAT_metadata.db&#39;</span>
<span class="n">debug_fp</span> <span class="o">=</span> <span class="s1">&#39;../logs/EUMETSAT_download.txt&#39;</span>
<span class="n">new_grid_fp</span><span class="o">=</span><span class="s1">&#39;../data/intermediate/new_grid_4km_TM.json&#39;</span>
<span class="n">new_coords_fp</span> <span class="o">=</span> <span class="s1">&#39;../data/intermediate/reproj_coords_TM_4km.csv&#39;</span>

<span class="n">in_zarr_bucket</span> <span class="o">=</span> <span class="s1">&#39;solar-pv-nowcasting-data/satellite/EUMETSAT/SEVIRI_RSS/OSGB36/all_zarr&#39;</span>
<span class="n">out_zarr_bucket</span> <span class="o">=</span> <span class="s1">&#39;solar-pv-nowcasting-data/satellite/EUMETSAT/SEVIRI_RSS/full_extent_TM_int16&#39;</span>
</code></pre></div>
<p><br></p>
<h3 id="loading-environment-variables">Loading Environment Variables<a class="headerlink" href="#loading-environment-variables" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">dotenv</span><span class="o">.</span><span class="n">load_dotenv</span><span class="p">(</span><span class="s1">&#39;../.env&#39;</span><span class="p">)</span>

<span class="n">user_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;USER_KEY&#39;</span><span class="p">)</span>
<span class="n">user_secret</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;USER_SECRET&#39;</span><span class="p">)</span>
<span class="n">slack_id</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SLACK_ID&#39;</span><span class="p">)</span>
<span class="n">slack_webhook_url</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SLACK_WEBHOOK_URL&#39;</span><span class="p">)</span>
</code></pre></div>
<p><br></p>
<h3 id="preparing-data-to-save-to-zarr">Preparing Data to Save to Zarr<a class="headerlink" href="#preparing-data-to-save-to-zarr" title="Permanent link">&para;</a></h3>
<p>We'll start by loading in one of the datasets we've just downloaded, in this instance we'll take the most recent one by identifying it from the metadata db.</p>
<div class="highlight"><pre><span></span><code><span class="n">dm</span> <span class="o">=</span> <span class="n">eumetsat</span><span class="o">.</span><span class="n">DownloadManager</span><span class="p">(</span><span class="n">user_key</span><span class="p">,</span> <span class="n">user_secret</span><span class="p">,</span> <span class="n">data_dir</span><span class="p">,</span> <span class="n">metadata_db_fp</span><span class="p">,</span> <span class="n">debug_fp</span><span class="p">)</span>

<span class="n">df_metadata</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">get_df_metadata</span><span class="p">()</span>

<span class="n">df_metadata</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>2021-01-08 09:43:50,879 - INFO - ********** Download Manager Initialised **************
</code></pre></div>
<table>
<thead>
<tr>
<th align="right">('Unnamed: 0_level_0', 'id')</th>
<th align="left">('start_date', 'Unnamed: 1_level_1')</th>
<th align="left">('end_date', 'Unnamed: 2_level_1')</th>
<th align="left">('result_time', 'Unnamed: 3_level_1')</th>
<th align="left">('platform_short_name', 'Unnamed: 4_level_1')</th>
<th align="left">('platform_orbit_type', 'Unnamed: 5_level_1')</th>
<th align="left">('instrument_name', 'Unnamed: 6_level_1')</th>
<th align="left">('sensor_op_mode', 'Unnamed: 7_level_1')</th>
<th align="left">('center_srs_name', 'Unnamed: 8_level_1')</th>
<th align="left">('center_position', 'Unnamed: 9_level_1')</th>
<th align="left">('file_name', 'Unnamed: 10_level_1')</th>
<th align="right">('file_size', 'Unnamed: 11_level_1')</th>
<th align="right">('missing_pct', 'Unnamed: 12_level_1')</th>
<th align="left">('downloaded', 'Unnamed: 13_level_1')</th>
</tr>
</thead>
<tbody>
<tr>
<td align="right">332</td>
<td align="left">2020-01-01 00:00:07.683</td>
<td align="left">2020-01-01 00:04:14.102</td>
<td align="left">2020-01-01 00:04:14.102</td>
<td align="left">MSG3</td>
<td align="left">GEO</td>
<td align="left">SEVIRI</td>
<td align="left">RSS</td>
<td align="left">EPSG:4326</td>
<td align="left">0 9.5</td>
<td align="left">MSG3-SEVI-MSG15-0100-NA-20200101000414.1020000...</td>
<td align="right">99819</td>
<td align="right">0</td>
<td align="left">2021-01-07 20:39:02.727875</td>
</tr>
<tr>
<td align="right">333</td>
<td align="left">2020-01-01 00:05:08.795</td>
<td align="left">2020-01-01 00:09:15.215</td>
<td align="left">2020-01-01 00:09:15.215</td>
<td align="left">MSG3</td>
<td align="left">GEO</td>
<td align="left">SEVIRI</td>
<td align="left">RSS</td>
<td align="left">EPSG:4326</td>
<td align="left">0 9.5</td>
<td align="left">MSG3-SEVI-MSG15-0100-NA-20200101000915.2150000...</td>
<td align="right">99819</td>
<td align="right">0</td>
<td align="left">2021-01-07 20:40:35.463153</td>
</tr>
<tr>
<td align="right">334</td>
<td align="left">2020-01-01 00:10:09.908</td>
<td align="left">2020-01-01 00:14:16.328</td>
<td align="left">2020-01-01 00:14:16.328</td>
<td align="left">MSG3</td>
<td align="left">GEO</td>
<td align="left">SEVIRI</td>
<td align="left">RSS</td>
<td align="left">EPSG:4326</td>
<td align="left">0 9.5</td>
<td align="left">MSG3-SEVI-MSG15-0100-NA-20200101001416.3280000...</td>
<td align="right">99819</td>
<td align="right">0</td>
<td align="left">2021-01-07 20:42:01.806167</td>
</tr>
<tr>
<td align="right">335</td>
<td align="left">2020-01-01 00:15:11.021</td>
<td align="left">2020-01-01 00:19:17.440</td>
<td align="left">2020-01-01 00:19:17.440</td>
<td align="left">MSG3</td>
<td align="left">GEO</td>
<td align="left">SEVIRI</td>
<td align="left">RSS</td>
<td align="left">EPSG:4326</td>
<td align="left">0 9.5</td>
<td align="left">MSG3-SEVI-MSG15-0100-NA-20200101001917.4400000...</td>
<td align="right">99819</td>
<td align="right">0</td>
<td align="left">2021-01-07 20:42:42.769446</td>
</tr>
<tr>
<td align="right">336</td>
<td align="left">2021-01-07 20:50:09.828</td>
<td align="left">2021-01-07 20:54:16.209</td>
<td align="left">2021-01-07 20:54:16.209</td>
<td align="left">MSG3</td>
<td align="left">GEO</td>
<td align="left">SEVIRI</td>
<td align="left">RSS</td>
<td align="left">EPSG:4326</td>
<td align="left">0 9.5</td>
<td align="left">MSG3-SEVI-MSG15-0100-NA-20210107205416.2090000...</td>
<td align="right">99819</td>
<td align="right">0</td>
<td align="left">2021-01-07 21:37:09.110106</td>
</tr>
</tbody>
</table>
<p><br></p>
<p>We'll then load in the file</p>
<div class="highlight"><pre><span></span><code><span class="n">filename</span> <span class="o">=</span> <span class="n">df_metadata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_metadata</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;file_name&#39;</span><span class="p">]</span>
<span class="n">native_fp</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">data_dir</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s1">.nat&#39;</span>

<span class="n">severi_area_def</span> <span class="o">=</span> <span class="n">reproj</span><span class="o">.</span><span class="n">get_seviri_area_def</span><span class="p">(</span><span class="n">native_fp</span><span class="p">)</span>
<span class="n">seviri_crs</span> <span class="o">=</span> <span class="n">severi_area_def</span><span class="o">.</span><span class="n">to_cartopy_crs</span><span class="p">()</span>

<span class="n">scene</span> <span class="o">=</span> <span class="n">reproj</span><span class="o">.</span><span class="n">load_scene</span><span class="p">(</span><span class="n">native_fp</span><span class="p">)</span>
<span class="n">scene</span><span class="o">.</span><span class="n">load</span><span class="p">([</span><span class="s1">&#39;HRV&#39;</span><span class="p">])</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>/Users/laurence/software/anaconda3/envs/satip_dev/lib/python3.8/site-packages/pyproj/crs/crs.py:543: UserWarning: You will likely lose important projection information when converting to a PROJ string from another format. See: https://proj.org/faq.html#what-is-the-best-format-for-describing-coordinate-reference-systems
  proj_string = self.to_proj4()
/Users/laurence/software/anaconda3/envs/satip_dev/lib/python3.8/site-packages/pyproj/crs/crs.py:543: UserWarning: You will likely lose important projection information when converting to a PROJ string from another format. See: https://proj.org/faq.html#what-is-the-best-format-for-describing-coordinate-reference-systems
  proj_string = self.to_proj4()
</code></pre></div>
<p><br></p>
<p>And visualise it to test that everything is working</p>
<div class="highlight"><pre><span></span><code><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="n">seviri_crs</span><span class="p">)</span>

<span class="n">scene</span><span class="p">[</span><span class="s1">&#39;HRV&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;magma&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">coastlines</span><span class="p">(</span><span class="n">resolution</span><span class="o">=</span><span class="s1">&#39;50m&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>&lt;cartopy.mpl.feature_artist.FeatureArtist at 0x7fdf79164ca0&gt;
</code></pre></div>
<p><img alt="png" src="../img/nbs/output_11_1.png" /></p>
<p><br></p>
<p>We now need to reproject it</p>
<div class="highlight"><pre><span></span><code><span class="o">%%</span><span class="n">capture</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">stdout</span>
<span class="o">%%</span><span class="n">time</span>

<span class="n">reprojector</span> <span class="o">=</span> <span class="n">reproj</span><span class="o">.</span><span class="n">Reprojector</span><span class="p">(</span><span class="n">new_coords_fp</span><span class="p">,</span> <span class="n">new_grid_fp</span><span class="p">)</span>
<span class="n">ds_reproj</span> <span class="o">=</span> <span class="n">reprojector</span><span class="o">.</span><span class="n">reproject</span><span class="p">(</span><span class="n">native_fp</span><span class="p">,</span> <span class="n">reproj_library</span><span class="o">=</span><span class="s1">&#39;pyresample&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>CPU times: user 4.79 s, sys: 356 ms, total: 5.14 s
Wall time: 5.41 s
</code></pre></div>
<p><br></p>
<p>Which again we'll check through visualisation</p>
<div class="highlight"><pre><span></span><code><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">TransverseMercator</span><span class="p">())</span>

<span class="n">ds_reproj</span><span class="p">[</span><span class="s1">&#39;stacked_eumetsat_data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">variable</span><span class="o">=</span><span class="s1">&#39;HRV&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;magma&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">coastlines</span><span class="p">(</span><span class="n">resolution</span><span class="o">=</span><span class="s1">&#39;50m&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>&lt;ipython-input-12-53f177b0781d&gt;:2: UserWarning: The default value for the *approx* keyword argument to TransverseMercator will change from True to False after 0.18.
  ax = plt.axes(projection=ccrs.TransverseMercator())
/Users/laurence/software/anaconda3/envs/satip_dev/lib/python3.8/site-packages/dask/core.py:121: RuntimeWarning: invalid value encountered in cos
  return func(*(_execute_task(a, cache) for a in args))
/Users/laurence/software/anaconda3/envs/satip_dev/lib/python3.8/site-packages/dask/core.py:121: RuntimeWarning: invalid value encountered in sin
  return func(*(_execute_task(a, cache) for a in args))





&lt;cartopy.mpl.feature_artist.FeatureArtist at 0x7fdf55fddf70&gt;
</code></pre></div>
<p><img alt="png" src="../img/nbs/output_15_2.png" /></p>
<p><br></p>
<h3 id="compressing">Compressing<a class="headerlink" href="#compressing" title="Permanent link">&para;</a></h3>
<p>We'll now develop our compressor class that will reduce the size of the datasets that we save to Zarr, in this instance we'll normalize the data and transform it to Int16. This has been found to reduce the size by ~50%.</p>
<div class="highlight"><pre><span></span><code><span class="c1">#exports</span>
<span class="k">def</span> <span class="nf">add_constant_coord_to_da</span><span class="p">(</span><span class="n">da</span><span class="p">,</span> <span class="n">coord_name</span><span class="p">,</span> <span class="n">coord_val</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adds a new coordinate with a </span>
<span class="sd">    constant value to the DataArray</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    da : xr.DataArray</span>
<span class="sd">        DataArrray which will have the new coords added to it</span>
<span class="sd">    coord_name : str</span>
<span class="sd">        Name for the new coordinate dimensions</span>
<span class="sd">    coord_val</span>
<span class="sd">        Value that will be assigned to the new coordinates</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    da : xr.DataArray</span>
<span class="sd">        DataArrray with the new coords added to it</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">da</span> <span class="o">=</span> <span class="p">(</span><span class="n">da</span>
          <span class="o">.</span><span class="n">assign_coords</span><span class="p">({</span><span class="n">coord_name</span><span class="p">:</span><span class="n">coord_val</span><span class="p">})</span>
          <span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">coord_name</span><span class="p">)</span>
         <span class="p">)</span>

    <span class="k">return</span> <span class="n">da</span>

<span class="k">class</span> <span class="nc">Compressor</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                 <span class="n">bits_per_pixel</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> 
                 <span class="n">mins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">1.2278595</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.5118103</span><span class="p">,</span> <span class="o">-</span><span class="mf">64.83977</span><span class="p">,</span> <span class="mf">63.404694</span><span class="p">,</span> <span class="mf">2.844452</span><span class="p">,</span> <span class="mf">199.10002</span><span class="p">,</span> <span class="o">-</span><span class="mf">17.254883</span><span class="p">,</span> <span class="o">-</span><span class="mf">26.29155</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.1009827</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.4184198</span><span class="p">,</span> <span class="mf">199.57048</span><span class="p">,</span> <span class="mf">198.95093</span><span class="p">]),</span> 
                 <span class="n">maxs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">103.90016</span><span class="p">,</span> <span class="mf">69.60857</span><span class="p">,</span> <span class="mf">339.15588</span><span class="p">,</span> <span class="mf">340.26526</span><span class="p">,</span> <span class="mf">317.86752</span><span class="p">,</span> <span class="mf">313.2767</span><span class="p">,</span> <span class="mf">315.99194</span><span class="p">,</span> <span class="mf">274.82297</span><span class="p">,</span> <span class="mf">93.786545</span><span class="p">,</span> <span class="mf">101.34922</span><span class="p">,</span> <span class="mf">249.91806</span><span class="p">,</span> <span class="mf">286.96323</span><span class="p">]),</span>
                 <span class="n">variable_order</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;HRV&#39;</span><span class="p">,</span> <span class="s1">&#39;IR_016&#39;</span><span class="p">,</span> <span class="s1">&#39;IR_039&#39;</span><span class="p">,</span> <span class="s1">&#39;IR_087&#39;</span><span class="p">,</span> <span class="s1">&#39;IR_097&#39;</span><span class="p">,</span> <span class="s1">&#39;IR_108&#39;</span><span class="p">,</span> <span class="s1">&#39;IR_120&#39;</span><span class="p">,</span> <span class="s1">&#39;IR_134&#39;</span><span class="p">,</span> <span class="s1">&#39;VIS006&#39;</span><span class="p">,</span> <span class="s1">&#39;VIS008&#39;</span><span class="p">,</span> <span class="s1">&#39;WV_062&#39;</span><span class="p">,</span> <span class="s1">&#39;WV_073&#39;</span><span class="p">]</span>
                <span class="p">):</span>

        <span class="n">locals_</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()</span>
        <span class="n">attrs_to_add</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;bits_per_pixel&#39;</span><span class="p">,</span> <span class="s1">&#39;mins&#39;</span><span class="p">,</span> <span class="s1">&#39;maxs&#39;</span><span class="p">,</span> <span class="s1">&#39;variable_order&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs_to_add</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">locals_</span><span class="p">[</span><span class="n">attr</span><span class="p">])</span>

        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">da</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mins</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">dims</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxs</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">dims</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">variable_order</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The mins are: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mins</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The maxs are: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">maxs</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The variable order is: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">variable_order</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">compress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">da</span><span class="p">):</span>
        <span class="n">da_meta</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">attrs</span> 

        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;mins&#39;</span><span class="p">,</span> <span class="s1">&#39;maxs&#39;</span><span class="p">]:</span>
            <span class="k">assert</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s1"> must be set in initialisation or through `fit`&#39;</span>

        <span class="k">if</span> <span class="s1">&#39;time&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">da</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
            <span class="n">time</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">da_meta</span><span class="p">[</span><span class="s1">&#39;end_time&#39;</span><span class="p">])</span>
            <span class="n">da</span> <span class="o">=</span> <span class="n">add_constant_coord_to_da</span><span class="p">(</span><span class="n">da</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>

        <span class="n">da</span> <span class="o">=</span> <span class="p">(</span><span class="n">da</span>
              <span class="o">.</span><span class="n">reindex</span><span class="p">({</span><span class="s1">&#39;variable&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">variable_order</span><span class="p">})</span>
              <span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;variable&#39;</span><span class="p">)</span>
             <span class="p">)</span>

        <span class="n">upper_bound</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="bp">self</span><span class="o">.</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">new_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxs</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">mins</span>

        <span class="n">da</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mins</span>
        <span class="n">da</span> <span class="o">/=</span> <span class="n">new_max</span>
        <span class="n">da</span> <span class="o">*=</span> <span class="n">upper_bound</span>

        <span class="n">da</span> <span class="o">=</span> <span class="p">(</span><span class="n">da</span>
              <span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
              <span class="o">.</span><span class="n">round</span><span class="p">()</span>
              <span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
             <span class="p">)</span>

        <span class="n">da</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;meta&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">da_meta</span><span class="p">)}</span> <span class="c1"># Must be serialisable</span>

        <span class="k">return</span> <span class="n">da</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="o">%%</span><span class="n">time</span>

<span class="n">compressor</span> <span class="o">=</span> <span class="n">Compressor</span><span class="p">()</span>

<span class="n">da_compressed</span> <span class="o">=</span> <span class="n">compressor</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">ds_reproj</span><span class="p">[</span><span class="s1">&#39;stacked_eumetsat_data&#39;</span><span class="p">])</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>CPU times: user 20.5 ms, sys: 1.85 ms, total: 22.3 ms
Wall time: 21.2 ms
</code></pre></div>
<p><br></p>
<h3 id="saving-to-zarr">Saving to Zarr<a class="headerlink" href="#saving-to-zarr" title="Permanent link">&para;</a></h3>
<p>We'll now create a helper function for saving the data-array to a zarr database</p>
<div class="highlight"><pre><span></span><code><span class="c1"># exports</span>
<span class="n">get_time_as_unix</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">da</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">((</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">da</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;1970-01-01&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">())</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>

<span class="k">def</span> <span class="nf">save_da_to_zarr</span><span class="p">(</span><span class="n">da</span><span class="p">,</span> <span class="n">zarr_bucket</span><span class="p">,</span> <span class="n">dim_order</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;variable&#39;</span><span class="p">],</span> <span class="n">zarr_mode</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">):</span>
    <span class="n">da</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="o">*</span><span class="n">dim_order</span><span class="p">)</span>
    <span class="n">da</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_time_as_unix</span><span class="p">(</span><span class="n">da</span><span class="p">)</span>

    <span class="n">_</span><span class="p">,</span> <span class="n">y_size</span><span class="p">,</span> <span class="n">x_size</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">out_store</span> <span class="o">=</span> <span class="n">gcsfs</span><span class="o">.</span><span class="n">GCSMap</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="n">zarr_bucket</span><span class="p">,</span> <span class="n">gcs</span><span class="o">=</span><span class="n">gcsfs</span><span class="o">.</span><span class="n">GCSFileSystem</span><span class="p">())</span>

    <span class="n">chunks</span> <span class="o">=</span> <span class="p">(</span><span class="mi">36</span><span class="p">,</span> <span class="n">y_size</span><span class="p">,</span> <span class="n">x_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">({</span><span class="s1">&#39;stacked_eumetsat_data&#39;</span><span class="p">:</span> <span class="n">da</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">chunks</span><span class="p">)})</span>

    <span class="n">zarr_mode_to_extra_kwargs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;append_dim&#39;</span><span class="p">:</span> <span class="s1">&#39;time&#39;</span>
        <span class="p">},</span>
        <span class="s1">&#39;w&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;encoding&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;stacked_eumetsat_data&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;compressor&#39;</span><span class="p">:</span> <span class="n">numcodecs</span><span class="o">.</span><span class="n">Blosc</span><span class="p">(</span><span class="n">cname</span><span class="o">=</span><span class="s1">&#39;zstd&#39;</span><span class="p">,</span> <span class="n">clevel</span><span class="o">=</span><span class="mi">5</span><span class="p">),</span>
                    <span class="s1">&#39;chunks&#39;</span><span class="p">:</span> <span class="n">chunks</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">assert</span> <span class="n">zarr_mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">],</span> <span class="s1">&#39;`zarr_mode` must be one of: `a`, `w`&#39;</span>
    <span class="n">extra_kwargs</span> <span class="o">=</span> <span class="n">zarr_mode_to_extra_kwargs</span><span class="p">[</span><span class="n">zarr_mode</span><span class="p">]</span>

    <span class="n">ds</span><span class="o">.</span><span class="n">to_zarr</span><span class="p">(</span><span class="n">out_store</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">zarr_mode</span><span class="p">,</span> <span class="n">consolidated</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">extra_kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ds</span>
</code></pre></div>
<p><br></p>
<p>Now we can save it!</p>
<div class="highlight"><pre><span></span><code><span class="n">save_data</span> <span class="o">=</span> <span class="kc">False</span>

<span class="k">if</span> <span class="n">save_data</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">out_zarr_bucket</span> <span class="o">=</span> <span class="s1">&#39;solar-pv-nowcasting-data/satellite/EUMETSAT/SEVIRI_RSS/full_extent_TM_int16&#39;</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">save_da_to_zarr</span><span class="p">(</span><span class="n">da_compressed</span><span class="p">,</span> <span class="n">out_zarr_bucket</span><span class="p">,</span> <span class="n">zarr_mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
</code></pre></div>
<p><br></p>
<h3 id="loading-zarr-data">Loading Zarr Data<a class="headerlink" href="#loading-zarr-data" title="Permanent link">&para;</a></h3>
<p>We'll start by defining a loading function and a replacement for the standard <code>gcsfs.utils</code> <code>is_retriable</code> function</p>
<p><br></p>
<p>We'll now read it in</p>
<div class="highlight"><pre><span></span><code><span class="o">%%</span><span class="n">time</span>

<span class="n">loaded_xarray</span> <span class="o">=</span> <span class="n">load_from_zarr_bucket</span><span class="p">(</span><span class="n">out_zarr_bucket</span><span class="p">)</span>

<span class="n">loaded_xarray</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>CPU times: user 760 ms, sys: 73.8 ms, total: 834 ms
Wall time: 3.56 s
</code></pre></div>
<div><svg style="position: absolute; width: 0; height: 0; overflow: hidden">
<defs>
<symbol id="icon-database" viewBox="0 0 32 32">
<path d="M16 0c-8.837 0-16 2.239-16 5v4c0 2.761 7.163 5 16 5s16-2.239 16-5v-4c0-2.761-7.163-5-16-5z"></path>
<path d="M16 17c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
<path d="M16 26c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
</symbol>
<symbol id="icon-file-text2" viewBox="0 0 32 32">
<path d="M28.681 7.159c-0.694-0.947-1.662-2.053-2.724-3.116s-2.169-2.030-3.116-2.724c-1.612-1.182-2.393-1.319-2.841-1.319h-15.5c-1.378 0-2.5 1.121-2.5 2.5v27c0 1.378 1.122 2.5 2.5 2.5h23c1.378 0 2.5-1.122 2.5-2.5v-19.5c0-0.448-0.137-1.23-1.319-2.841zM24.543 5.457c0.959 0.959 1.712 1.825 2.268 2.543h-4.811v-4.811c0.718 0.556 1.584 1.309 2.543 2.268zM28 29.5c0 0.271-0.229 0.5-0.5 0.5h-23c-0.271 0-0.5-0.229-0.5-0.5v-27c0-0.271 0.229-0.5 0.5-0.5 0 0 15.499-0 15.5 0v7c0 0.552 0.448 1 1 1h7v19.5z"></path>
<path d="M23 26h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 22h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 18h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
</symbol>
</defs>
</svg>
<style>/* CSS stylesheet for displaying xarray objects in jupyterlab.
 *
 */

:root {
  --xr-font-color0: var(--jp-content-font-color0, rgba(0, 0, 0, 1));
  --xr-font-color2: var(--jp-content-font-color2, rgba(0, 0, 0, 0.54));
  --xr-font-color3: var(--jp-content-font-color3, rgba(0, 0, 0, 0.38));
  --xr-border-color: var(--jp-border-color2, #e0e0e0);
  --xr-disabled-color: var(--jp-layout-color3, #bdbdbd);
  --xr-background-color: var(--jp-layout-color0, white);
  --xr-background-color-row-even: var(--jp-layout-color1, white);
  --xr-background-color-row-odd: var(--jp-layout-color2, #eeeeee);
}

html[theme=dark],
body.vscode-dark {
  --xr-font-color0: rgba(255, 255, 255, 1);
  --xr-font-color2: rgba(255, 255, 255, 0.54);
  --xr-font-color3: rgba(255, 255, 255, 0.38);
  --xr-border-color: #1F1F1F;
  --xr-disabled-color: #515151;
  --xr-background-color: #111111;
  --xr-background-color-row-even: #111111;
  --xr-background-color-row-odd: #313131;
}

.xr-wrap {
  display: block;
  min-width: 300px;
  max-width: 700px;
}

.xr-text-repr-fallback {
  /* fallback to plain text repr when CSS is not injected (untrusted notebook) */
  display: none;
}

.xr-header {
  padding-top: 6px;
  padding-bottom: 6px;
  margin-bottom: 4px;
  border-bottom: solid 1px var(--xr-border-color);
}

.xr-header > div,
.xr-header > ul {
  display: inline;
  margin-top: 0;
  margin-bottom: 0;
}

.xr-obj-type,
.xr-array-name {
  margin-left: 2px;
  margin-right: 10px;
}

.xr-obj-type {
  color: var(--xr-font-color2);
}

.xr-sections {
  padding-left: 0 !important;
  display: grid;
  grid-template-columns: 150px auto auto 1fr 20px 20px;
}

.xr-section-item {
  display: contents;
}

.xr-section-item input {
  display: none;
}

.xr-section-item input + label {
  color: var(--xr-disabled-color);
}

.xr-section-item input:enabled + label {
  cursor: pointer;
  color: var(--xr-font-color2);
}

.xr-section-item input:enabled + label:hover {
  color: var(--xr-font-color0);
}

.xr-section-summary {
  grid-column: 1;
  color: var(--xr-font-color2);
  font-weight: 500;
}

.xr-section-summary > span {
  display: inline-block;
  padding-left: 0.5em;
}

.xr-section-summary-in:disabled + label {
  color: var(--xr-font-color2);
}

.xr-section-summary-in + label:before {
  display: inline-block;
  content: 'â–º';
  font-size: 11px;
  width: 15px;
  text-align: center;
}

.xr-section-summary-in:disabled + label:before {
  color: var(--xr-disabled-color);
}

.xr-section-summary-in:checked + label:before {
  content: 'â–¼';
}

.xr-section-summary-in:checked + label > span {
  display: none;
}

.xr-section-summary,
.xr-section-inline-details {
  padding-top: 4px;
  padding-bottom: 4px;
}

.xr-section-inline-details {
  grid-column: 2 / -1;
}

.xr-section-details {
  display: none;
  grid-column: 1 / -1;
  margin-bottom: 5px;
}

.xr-section-summary-in:checked ~ .xr-section-details {
  display: contents;
}

.xr-array-wrap {
  grid-column: 1 / -1;
  display: grid;
  grid-template-columns: 20px auto;
}

.xr-array-wrap > label {
  grid-column: 1;
  vertical-align: top;
}

.xr-preview {
  color: var(--xr-font-color3);
}

.xr-array-preview,
.xr-array-data {
  padding: 0 5px !important;
  grid-column: 2;
}

.xr-array-data,
.xr-array-in:checked ~ .xr-array-preview {
  display: none;
}

.xr-array-in:checked ~ .xr-array-data,
.xr-array-preview {
  display: inline-block;
}

.xr-dim-list {
  display: inline-block !important;
  list-style: none;
  padding: 0 !important;
  margin: 0;
}

.xr-dim-list li {
  display: inline-block;
  padding: 0;
  margin: 0;
}

.xr-dim-list:before {
  content: '(';
}

.xr-dim-list:after {
  content: ')';
}

.xr-dim-list li:not(:last-child):after {
  content: ',';
  padding-right: 5px;
}

.xr-has-index {
  font-weight: bold;
}

.xr-var-list,
.xr-var-item {
  display: contents;
}

.xr-var-item > div,
.xr-var-item label,
.xr-var-item > .xr-var-name span {
  background-color: var(--xr-background-color-row-even);
  margin-bottom: 0;
}

.xr-var-item > .xr-var-name:hover span {
  padding-right: 5px;
}

.xr-var-list > li:nth-child(odd) > div,
.xr-var-list > li:nth-child(odd) > label,
.xr-var-list > li:nth-child(odd) > .xr-var-name span {
  background-color: var(--xr-background-color-row-odd);
}

.xr-var-name {
  grid-column: 1;
}

.xr-var-dims {
  grid-column: 2;
}

.xr-var-dtype {
  grid-column: 3;
  text-align: right;
  color: var(--xr-font-color2);
}

.xr-var-preview {
  grid-column: 4;
}

.xr-var-name,
.xr-var-dims,
.xr-var-dtype,
.xr-preview,
.xr-attrs dt {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  padding-right: 10px;
}

.xr-var-name:hover,
.xr-var-dims:hover,
.xr-var-dtype:hover,
.xr-attrs dt:hover {
  overflow: visible;
  width: auto;
  z-index: 1;
}

.xr-var-attrs,
.xr-var-data {
  display: none;
  background-color: var(--xr-background-color) !important;
  padding-bottom: 5px !important;
}

.xr-var-attrs-in:checked ~ .xr-var-attrs,
.xr-var-data-in:checked ~ .xr-var-data {
  display: block;
}

.xr-var-data > table {
  float: right;
}

.xr-var-name span,
.xr-var-data,
.xr-attrs {
  padding-left: 25px !important;
}

.xr-attrs,
.xr-var-attrs,
.xr-var-data {
  grid-column: 1 / -1;
}

dl.xr-attrs {
  padding: 0;
  margin: 0;
  display: grid;
  grid-template-columns: 125px auto;
}

.xr-attrs dt,
.xr-attrs dd {
  padding: 0;
  margin: 0;
  float: left;
  padding-right: 10px;
  width: auto;
}

.xr-attrs dt {
  font-weight: normal;
  grid-column: 1;
}

.xr-attrs dt:hover span {
  display: inline-block;
  background: var(--xr-background-color);
  padding-right: 10px;
}

.xr-attrs dd {
  grid-column: 2;
  white-space: pre-wrap;
  word-break: break-all;
}

.xr-icon-database,
.xr-icon-file-text2 {
  display: inline-block;
  vertical-align: middle;
  width: 1em;
  height: 1.5em !important;
  stroke-width: 0;
  stroke: currentColor;
  fill: currentColor;
}
</style><pre class='xr-text-repr-fallback'>&lt;xarray.DataArray &#x27;time&#x27; (time: 781)&gt;
array([&#x27;2020-12-16T18:40:08.000000000&#x27;, &#x27;2021-01-07T12:04:16.000000000&#x27;,
       &#x27;2021-01-07T12:09:16.000000000&#x27;, ..., &#x27;2021-01-08T01:19:16.000000000&#x27;,
       &#x27;2021-01-08T01:24:16.000000000&#x27;, &#x27;2021-01-08T01:29:15.000000000&#x27;],
      dtype=&#x27;datetime64[ns]&#x27;)
Coordinates:
  * time     (time) datetime64[ns] 2020-12-16T18:40:08 ... 2021-01-08T01:29:15</pre><div class='xr-wrap' hidden><div class='xr-header'><div class='xr-obj-type'>xarray.DataArray</div><div class='xr-array-name'>'time'</div><ul class='xr-dim-list'><li><span class='xr-has-index'>time</span>: 781</li></ul></div><ul class='xr-sections'><li class='xr-section-item'><div class='xr-array-wrap'><input id='section-6a1a37d4-f518-47c3-afe1-18382c743487' class='xr-array-in' type='checkbox' checked><label for='section-6a1a37d4-f518-47c3-afe1-18382c743487' title='Show/hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-array-preview xr-preview'><span>2020-12-16T18:40:08 2021-01-07T12:04:16 ... 2021-01-08T01:29:15</span></div><div class='xr-array-data'><pre>array([&#x27;2020-12-16T18:40:08.000000000&#x27;, &#x27;2021-01-07T12:04:16.000000000&#x27;,
       &#x27;2021-01-07T12:09:16.000000000&#x27;, ..., &#x27;2021-01-08T01:19:16.000000000&#x27;,
       &#x27;2021-01-08T01:24:16.000000000&#x27;, &#x27;2021-01-08T01:29:15.000000000&#x27;],
      dtype=&#x27;datetime64[ns]&#x27;)</pre></div></div></li><li class='xr-section-item'><input id='section-3c87c3f6-d6d0-4949-85f5-df76a1c0dd5c' class='xr-section-summary-in' type='checkbox'  checked><label for='section-3c87c3f6-d6d0-4949-85f5-df76a1c0dd5c' class='xr-section-summary' >Coordinates: <span>(1)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><ul class='xr-var-list'><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>time</span></div><div class='xr-var-dims'>(time)</div><div class='xr-var-dtype'>datetime64[ns]</div><div class='xr-var-preview xr-preview'>2020-12-16T18:40:08 ... 2021-01-...</div><input id='attrs-99b82b26-f8ed-4c75-a648-669bd577346a' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-99b82b26-f8ed-4c75-a648-669bd577346a' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-4fc21742-90d1-428a-930f-262d050cdcc0' class='xr-var-data-in' type='checkbox'><label for='data-4fc21742-90d1-428a-930f-262d050cdcc0' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([&#x27;2020-12-16T18:40:08.000000000&#x27;, &#x27;2021-01-07T12:04:16.000000000&#x27;,
       &#x27;2021-01-07T12:09:16.000000000&#x27;, ..., &#x27;2021-01-08T01:19:16.000000000&#x27;,
       &#x27;2021-01-08T01:24:16.000000000&#x27;, &#x27;2021-01-08T01:29:15.000000000&#x27;],
      dtype=&#x27;datetime64[ns]&#x27;)</pre></div></li></ul></div></li><li class='xr-section-item'><input id='section-28bcaf3a-987d-4dcb-b444-b52439e493ee' class='xr-section-summary-in' type='checkbox' disabled ><label for='section-28bcaf3a-987d-4dcb-b444-b52439e493ee' class='xr-section-summary'  title='Expand/collapse section'>Attributes: <span>(0)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><dl class='xr-attrs'></dl></div></li></ul></div></div>

<p><br></p>
<p>And finally we can plot the results</p>
<div class="highlight"><pre><span></span><code><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">TransverseMercator</span><span class="p">())</span>

<span class="n">loaded_xarray</span><span class="p">[</span><span class="s1">&#39;stacked_eumetsat_data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">variable</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;magma&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">200</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">coastlines</span><span class="p">(</span><span class="n">resolution</span><span class="o">=</span><span class="s1">&#39;50m&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>&lt;ipython-input-19-f7e189d5f897&gt;:2: UserWarning: The default value for the *approx* keyword argument to TransverseMercator will change from True to False after 0.18.
  ax = plt.axes(projection=ccrs.TransverseMercator())





&lt;cartopy.mpl.feature_artist.FeatureArtist at 0x7fdf4185de80&gt;
</code></pre></div>
<p><img alt="png" src="../img/nbs/output_28_2.png" /></p>
<p><br></p>
<p>We can also identify missing datasets which will be useful for filling them in later</p>
<div class="highlight"><pre><span></span><code><span class="c1">#exports</span>
<span class="k">def</span> <span class="nf">identifying_missing_datasets</span><span class="p">(</span><span class="n">start_date</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">end_date</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">eumetsat_zarr_bucket</span><span class="o">=</span><span class="s1">&#39;solar-pv-nowcasting-data/satellite/EUMETSAT/SEVIRI_RSS/full_extent_TM_int16&#39;</span><span class="p">):</span>
    <span class="c1"># Identifying date range if not fully provided</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">start_date</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">end_date</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="n">ds_eumetsat</span> <span class="o">=</span> <span class="n">load_from_zarr_bucket</span><span class="p">(</span><span class="n">eumetsat_zarr_bucket</span><span class="p">)</span>
        <span class="n">start_date</span> <span class="o">=</span> <span class="n">ds_eumetsat</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
        <span class="n">end_date</span> <span class="o">=</span> <span class="n">ds_eumetsat</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Earliest </span><span class="si">{</span><span class="n">start_date</span><span class="si">}</span><span class="s1">, latest </span><span class="si">{</span><span class="n">end_date</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># have to loop this by month for the API</span>
    <span class="n">month_split</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s2">&quot;2020-01-01T00:09:15.000000000&quot;</span><span class="p">,</span> <span class="s2">&quot;2021-01-08T01:29:15.000000000&quot;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s2">&quot;M&quot;</span><span class="p">)</span>
    <span class="n">missing_datasets</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">track</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">month_split</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)):</span>

        <span class="c1"># Identifying all potential datasets over specified date range</span>
        <span class="n">datasets</span> <span class="o">=</span> <span class="n">eumetsat</span><span class="o">.</span><span class="n">identify_available_datasets</span><span class="p">(</span><span class="n">month_split</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">month_split</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># Extracting the datetime each dataset was finished</span>
        <span class="n">end_dates</span> <span class="o">=</span> <span class="p">[</span><span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">][</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">]</span>
        <span class="n">cleaned_end_dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">end_dates</span><span class="p">)</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">tz_convert</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Identifying missing datasets from the Zarr DB</span>
        <span class="n">ds_eumetsat</span> <span class="o">=</span> <span class="n">load_from_zarr_bucket</span><span class="p">(</span><span class="n">eumetsat_zarr_bucket</span><span class="p">)</span>
        <span class="n">end_dates_to_datasets</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">cleaned_end_dates</span><span class="p">,</span> <span class="n">datasets</span><span class="p">))</span>
        <span class="n">missing_dates</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">cleaned_end_dates</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">ds_eumetsat</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="n">missing_datasets</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">data</span> <span class="k">for</span> <span class="n">date</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">end_dates_to_datasets</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">missing_dates</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">missing_datasets</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">missing_datasets</span> <span class="o">=</span> <span class="n">identifying_missing_datasets</span><span class="p">()</span>

<span class="n">JSON</span><span class="p">(</span><span class="n">missing_datasets</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>Earliest 2020-01-01T00:09:15.000000000, latest 2021-01-08T01:29:15.000000000
</code></pre></div>
<div><span class="Text-label" style="display:inline-block; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; min-width:0; max-width:15ex; vertical-align:middle; text-align:right"></span>
<progress style="width:60ex" max="11" value="3" class="Progress-main"/></progress>
<span class="Progress-label"><strong>27%</strong></span>
<span class="Iteration-label">3/11</span>
<span class="Time-label">[00:18<00:06, 6.02s/it]</span></div>

<div class="highlight"><pre><span></span><code><span class="n">JSON</span><span class="p">(</span><span class="n">missing_datasets</span><span class="p">)</span>
</code></pre></div>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../02_reproj/" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Reprojection
              </div>
            </div>
          </a>
        
        
          <a href="../04_gcp/" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                GCP Analytics
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/vendor.93c04032.min.js"></script>
      <script src="../assets/javascripts/bundle.83e5331e.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}</script>
      
      <script>
        app = initialize({
          base: "..",
          features: ['header.autohide', 'navigation.tabs', 'navigation.instant', 'search.suggest'],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.8c7e0a7e.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
        <script src="../javascripts/config.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>