
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-6.2.5">
    
    
      
        <title>Saving with Zarr - Satip Documentation</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.15aa0b43.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.75751829.min.css">
        
          
          
          <meta name="theme-color" content="#000000">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="black" data-md-color-accent="">
      
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#zarr" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href=".." title="Satip Documentation" class="md-header-nav__button md-logo" aria-label="Satip Documentation">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      <div class="md-header-nav__ellipsis">
        <div class="md-header-nav__topic">
          <span class="md-ellipsis">
            Satip Documentation
          </span>
        </div>
        <div class="md-header-nav__topic">
          <span class="md-ellipsis">
            
              Saving with Zarr
            
          </span>
        </div>
      </div>
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/openclimatefix/satip/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    openclimatefix/satip
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href=".." class="md-tabs__link">
      Home
    </a>
  </li>

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../101_downloading/" class="md-tabs__link">
        User Guide
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../about/OCF/" class="md-tabs__link">
        About
      </a>
    </li>
  

      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="../00_utils/" class="md-tabs__link md-tabs__link--active">
        Development
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Satip Documentation" class="md-nav__button md-logo" aria-label="Satip Documentation">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Satip Documentation
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/openclimatefix/satip/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    openclimatefix/satip
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      


  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2" >
      
      <label class="md-nav__link" for="nav-2">
        User Guide
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="User Guide" data-md-level="1">
        <label class="md-nav__title" for="nav-2">
          <span class="md-nav__icon md-icon"></span>
          User Guide
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../101_downloading/" class="md-nav__link">
        Downloading from EUMETSAT
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../102_reprojecting/" class="md-nav__link">
        Reprojecting
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../103_loading/" class="md-nav__link">
        Loading from Zarr
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../104_ts_analysis/" class="md-nav__link">
        Extracting Time-Series
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../105_summary/" class="md-nav__link">
        Database Summary
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      


  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" >
      
      <label class="md-nav__link" for="nav-3">
        About
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="About" data-md-level="1">
        <label class="md-nav__title" for="nav-3">
          <span class="md-nav__icon md-icon"></span>
          About
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../about/OCF/" class="md-nav__link">
        OCF
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../about/Solar%20Forecasting/" class="md-nav__link">
        Solar Forecasting
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      


  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4" checked>
      
      <label class="md-nav__link" for="nav-4">
        Development
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Development" data-md-level="1">
        <label class="md-nav__title" for="nav-4">
          <span class="md-nav__icon md-icon"></span>
          Development
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../00_utils/" class="md-nav__link">
        Utilities
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../01_eumetsat/" class="md-nav__link">
        Downloading
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../02_reproj/" class="md-nav__link">
        Reprojection
      </a>
    </li>
  

          
            
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Saving with Zarr
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Saving with Zarr
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#imports" class="md-nav__link">
    Imports
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#user-inputs" class="md-nav__link">
    User Inputs
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#loading-environment-variables" class="md-nav__link">
    Loading Environment Variables
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#preparing-data-to-save-to-zarr" class="md-nav__link">
    Preparing Data to Save to Zarr
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#compressing" class="md-nav__link">
    Compressing
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#saving-to-zarr" class="md-nav__link">
    Saving to Zarr
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#loading-zarr-data" class="md-nav__link">
    Loading Zarr Data
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../04_gcp/" class="md-nav__link">
        GCP Analytics
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../05_pipeline/" class="md-nav__link">
        Pipelines
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#imports" class="md-nav__link">
    Imports
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#user-inputs" class="md-nav__link">
    User Inputs
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#loading-environment-variables" class="md-nav__link">
    Loading Environment Variables
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#preparing-data-to-save-to-zarr" class="md-nav__link">
    Preparing Data to Save to Zarr
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#compressing" class="md-nav__link">
    Compressing
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#saving-to-zarr" class="md-nav__link">
    Saving to Zarr
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#loading-zarr-data" class="md-nav__link">
    Loading Zarr Data
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/openclimatefix/satip/edit/master/docs/03_zarr.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="zarr">Zarr<a class="headerlink" href="#zarr" title="Permanent link">&para;</a></h1>
<p><br></p>
<h3 id="imports">Imports<a class="headerlink" href="#imports" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>C:\Users\Ayrto\anaconda3\envs\satip_dev\lib\site-packages\google\auth\_default.py:69: UserWarning: Your application has authenticated using end user credentials from Google Cloud SDK without a quota project. You might receive a &quot;quota exceeded&quot; or &quot;API not enabled&quot; error. We recommend you rerun `gcloud auth application-default login` and make sure a quota project is added. Or you can use service accounts instead. For more information about service accounts, see https://cloud.google.com/docs/authentication/
  warnings.warn(_CLOUD_SDK_CREDENTIALS_WARNING)
Downloading: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 1/1 [00:00&lt;00:00,  1.28rows/s]
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">dotenv</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">cartopy.crs</span> <span class="k">as</span> <span class="nn">ccrs</span>

<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">JSON</span>
</code></pre></div>
<p><br></p>
<h3 id="user-inputs">User Inputs<a class="headerlink" href="#user-inputs" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">data_dir</span> <span class="o">=</span> <span class="s1">&#39;../data/raw&#39;</span>
<span class="n">metadata_db_fp</span> <span class="o">=</span> <span class="s1">&#39;../data/EUMETSAT_metadata.db&#39;</span>
<span class="n">debug_fp</span> <span class="o">=</span> <span class="s1">&#39;../logs/EUMETSAT_download.txt&#39;</span>
<span class="n">new_grid_fp</span><span class="o">=</span><span class="s1">&#39;../data/intermediate/new_grid_4km_TM.json&#39;</span>
<span class="n">new_coords_fp</span> <span class="o">=</span> <span class="s1">&#39;../data/intermediate/reproj_coords_TM_4km.csv&#39;</span>

<span class="n">in_zarr_bucket</span> <span class="o">=</span> <span class="s1">&#39;solar-pv-nowcasting-data/satellite/EUMETSAT/SEVIRI_RSS/OSGB36/all_zarr&#39;</span>
<span class="n">out_zarr_bucket</span> <span class="o">=</span> <span class="s1">&#39;solar-pv-nowcasting-data/satellite/EUMETSAT/SEVIRI_RSS/full_extent_TM_int16&#39;</span>
</code></pre></div>
<p><br></p>
<h3 id="loading-environment-variables">Loading Environment Variables<a class="headerlink" href="#loading-environment-variables" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">dotenv</span><span class="o">.</span><span class="n">load_dotenv</span><span class="p">(</span><span class="s1">&#39;../.env&#39;</span><span class="p">)</span>

<span class="n">user_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;USER_KEY&#39;</span><span class="p">)</span>
<span class="n">user_secret</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;USER_SECRET&#39;</span><span class="p">)</span>
<span class="n">slack_id</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SLACK_ID&#39;</span><span class="p">)</span>
<span class="n">slack_webhook_url</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SLACK_WEBHOOK_URL&#39;</span><span class="p">)</span>
</code></pre></div>
<p><br></p>
<h3 id="preparing-data-to-save-to-zarr">Preparing Data to Save to Zarr<a class="headerlink" href="#preparing-data-to-save-to-zarr" title="Permanent link">&para;</a></h3>
<p>We'll start by loading in one of the datasets we've just downloaded, in this instance we'll take the most recent one by identifying it from the metadata db.</p>
<div class="highlight"><pre><span></span><code><span class="n">dm</span> <span class="o">=</span> <span class="n">eumetsat</span><span class="o">.</span><span class="n">DownloadManager</span><span class="p">(</span><span class="n">user_key</span><span class="p">,</span> <span class="n">user_secret</span><span class="p">,</span> <span class="n">data_dir</span><span class="p">,</span> <span class="n">metadata_db_fp</span><span class="p">,</span> <span class="n">debug_fp</span><span class="p">)</span>

<span class="n">df_metadata</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">get_df_metadata</span><span class="p">()</span>

<span class="n">df_metadata</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>2021-03-19 13:36:06,283 - INFO - ********** Download Manager Initialised **************
</code></pre></div>
<table>
<thead>
<tr>
<th align="right">('Unnamed: 0_level_0', 'id')</th>
<th align="left">('start_date', 'Unnamed: 1_level_1')</th>
<th align="left">('end_date', 'Unnamed: 2_level_1')</th>
<th align="left">('result_time', 'Unnamed: 3_level_1')</th>
<th align="left">('platform_short_name', 'Unnamed: 4_level_1')</th>
<th align="left">('platform_orbit_type', 'Unnamed: 5_level_1')</th>
<th align="left">('instrument_name', 'Unnamed: 6_level_1')</th>
<th align="left">('sensor_op_mode', 'Unnamed: 7_level_1')</th>
<th align="left">('center_srs_name', 'Unnamed: 8_level_1')</th>
<th align="left">('center_position', 'Unnamed: 9_level_1')</th>
<th align="left">('file_name', 'Unnamed: 10_level_1')</th>
<th align="right">('file_size', 'Unnamed: 11_level_1')</th>
<th align="right">('missing_pct', 'Unnamed: 12_level_1')</th>
<th align="left">('downloaded', 'Unnamed: 13_level_1')</th>
</tr>
</thead>
<tbody>
<tr>
<td align="right">22</td>
<td align="left">2021-03-19 13:00:09.714</td>
<td align="left">2021-03-19 13:04:16.088</td>
<td align="left">2021-03-19 13:04:16.088</td>
<td align="left">MSG3</td>
<td align="left">GEO</td>
<td align="left">SEVIRI</td>
<td align="left">RSS</td>
<td align="left">EPSG:4326</td>
<td align="left">0 9.5</td>
<td align="left">MSG3-SEVI-MSG15-0100-NA-20210319130416.0880000...</td>
<td align="right">99819</td>
<td align="right">59</td>
<td align="left">2021-03-19 13:32:31.390670</td>
</tr>
<tr>
<td align="right">23</td>
<td align="left">2021-03-19 13:05:09.569</td>
<td align="left">2021-03-19 13:09:15.943</td>
<td align="left">2021-03-19 13:09:15.943</td>
<td align="left">MSG3</td>
<td align="left">GEO</td>
<td align="left">SEVIRI</td>
<td align="left">RSS</td>
<td align="left">EPSG:4326</td>
<td align="left">0 9.5</td>
<td align="left">MSG3-SEVI-MSG15-0100-NA-20210319130915.9430000...</td>
<td align="right">99819</td>
<td align="right">0</td>
<td align="left">2021-03-19 13:32:36.178702</td>
</tr>
<tr>
<td align="right">24</td>
<td align="left">2021-03-19 13:10:09.423</td>
<td align="left">2021-03-19 13:14:15.798</td>
<td align="left">2021-03-19 13:14:15.798</td>
<td align="left">MSG3</td>
<td align="left">GEO</td>
<td align="left">SEVIRI</td>
<td align="left">RSS</td>
<td align="left">EPSG:4326</td>
<td align="left">0 9.5</td>
<td align="left">MSG3-SEVI-MSG15-0100-NA-20210319131415.7980000...</td>
<td align="right">99819</td>
<td align="right">0</td>
<td align="left">2021-03-19 13:32:40.347753</td>
</tr>
<tr>
<td align="right">25</td>
<td align="left">2021-03-19 13:15:09.278</td>
<td align="left">2021-03-19 13:19:15.652</td>
<td align="left">2021-03-19 13:19:15.652</td>
<td align="left">MSG3</td>
<td align="left">GEO</td>
<td align="left">SEVIRI</td>
<td align="left">RSS</td>
<td align="left">EPSG:4326</td>
<td align="left">0 9.5</td>
<td align="left">MSG3-SEVI-MSG15-0100-NA-20210319131915.6520000...</td>
<td align="right">99819</td>
<td align="right">62</td>
<td align="left">2021-03-19 13:32:44.720295</td>
</tr>
<tr>
<td align="right">26</td>
<td align="left">2021-03-19 13:20:10.335</td>
<td align="left">2021-03-19 13:24:16.708</td>
<td align="left">2021-03-19 13:24:16.708</td>
<td align="left">MSG3</td>
<td align="left">GEO</td>
<td align="left">SEVIRI</td>
<td align="left">RSS</td>
<td align="left">EPSG:4326</td>
<td align="left">0 9.5</td>
<td align="left">MSG3-SEVI-MSG15-0100-NA-20210319132416.7080000...</td>
<td align="right">99819</td>
<td align="right">0</td>
<td align="left">2021-03-19 13:32:48.922629</td>
</tr>
</tbody>
</table>
<p><br></p>
<p>We'll then load in the file</p>
<div class="highlight"><pre><span></span><code><span class="n">filename</span> <span class="o">=</span> <span class="n">df_metadata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_metadata</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;file_name&#39;</span><span class="p">]</span>
<span class="n">native_fp</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">data_dir</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s1">.nat&#39;</span>

<span class="n">severi_area_def</span> <span class="o">=</span> <span class="n">reproj</span><span class="o">.</span><span class="n">get_seviri_area_def</span><span class="p">(</span><span class="n">native_fp</span><span class="p">)</span>
<span class="n">seviri_crs</span> <span class="o">=</span> <span class="n">severi_area_def</span><span class="o">.</span><span class="n">to_cartopy_crs</span><span class="p">()</span>

<span class="n">scene</span> <span class="o">=</span> <span class="n">reproj</span><span class="o">.</span><span class="n">load_scene</span><span class="p">(</span><span class="n">native_fp</span><span class="p">)</span>
<span class="n">scene</span><span class="o">.</span><span class="n">load</span><span class="p">([</span><span class="s1">&#39;HRV&#39;</span><span class="p">])</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>/Users/laurence/conda/envs/satip_dev/lib/python3.8/site-packages/pyproj/crs/crs.py:543: UserWarning: You will likely lose important projection information when converting to a PROJ string from another format. See: https://proj.org/faq.html#what-is-the-best-format-for-describing-coordinate-reference-systems
  proj_string = self.to_proj4()
/Users/laurence/conda/envs/satip_dev/lib/python3.8/site-packages/pyproj/crs/crs.py:543: UserWarning: You will likely lose important projection information when converting to a PROJ string from another format. See: https://proj.org/faq.html#what-is-the-best-format-for-describing-coordinate-reference-systems
  proj_string = self.to_proj4()
</code></pre></div>
<p><br></p>
<p>And visualise it to test that everything is working</p>
<div class="highlight"><pre><span></span><code><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="n">seviri_crs</span><span class="p">)</span>

<span class="n">scene</span><span class="p">[</span><span class="s1">&#39;HRV&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;magma&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">coastlines</span><span class="p">(</span><span class="n">resolution</span><span class="o">=</span><span class="s1">&#39;50m&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>&lt;cartopy.mpl.feature_artist.FeatureArtist at 0x7fc2c8619880&gt;
</code></pre></div>
<p><img alt="png" src="../img/nbs/output_12_1.png" /></p>
<p><br></p>
<p>We now need to reproject it</p>
<div class="highlight"><pre><span></span><code><span class="o">%%</span><span class="n">capture</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">stdout</span>
<span class="o">%%</span><span class="n">time</span>

<span class="n">reprojector</span> <span class="o">=</span> <span class="n">reproj</span><span class="o">.</span><span class="n">Reprojector</span><span class="p">(</span><span class="n">new_coords_fp</span><span class="p">,</span> <span class="n">new_grid_fp</span><span class="p">)</span>
<span class="n">ds_reproj</span> <span class="o">=</span> <span class="n">reprojector</span><span class="o">.</span><span class="n">reproject</span><span class="p">(</span><span class="n">native_fp</span><span class="p">,</span> <span class="n">reproj_library</span><span class="o">=</span><span class="s1">&#39;pyresample&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>CPU times: user 2.23 s, sys: 104 ms, total: 2.33 s
Wall time: 2.38 s
</code></pre></div>
<p><br></p>
<p>Which again we'll check through visualisation</p>
<div class="highlight"><pre><span></span><code><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">TransverseMercator</span><span class="p">())</span>

<span class="n">ds_reproj</span><span class="p">[</span><span class="s1">&#39;stacked_eumetsat_data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">variable</span><span class="o">=</span><span class="s1">&#39;HRV&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;magma&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">coastlines</span><span class="p">(</span><span class="n">resolution</span><span class="o">=</span><span class="s1">&#39;50m&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>&lt;ipython-input-10-53f177b0781d&gt;:2: UserWarning: The default value for the *approx* keyword argument to TransverseMercator will change from True to False after 0.18.
  ax = plt.axes(projection=ccrs.TransverseMercator())
/Users/laurence/conda/envs/satip_dev/lib/python3.8/site-packages/dask/core.py:121: RuntimeWarning: invalid value encountered in sin
  return func(*(_execute_task(a, cache) for a in args))
/Users/laurence/conda/envs/satip_dev/lib/python3.8/site-packages/dask/core.py:121: RuntimeWarning: invalid value encountered in cos
  return func(*(_execute_task(a, cache) for a in args))





&lt;cartopy.mpl.feature_artist.FeatureArtist at 0x7fc2c86dd9a0&gt;
</code></pre></div>
<p><img alt="png" src="../img/nbs/output_16_2.png" /></p>
<div class="highlight"><pre><span></span><code><span class="n">ds_reproj</span><span class="p">[</span><span class="s1">&#39;stacked_eumetsat_data&#39;</span><span class="p">]</span>
</code></pre></div>
<div><svg style="position: absolute; width: 0; height: 0; overflow: hidden">
<defs>
<symbol id="icon-database" viewBox="0 0 32 32">
<path d="M16 0c-8.837 0-16 2.239-16 5v4c0 2.761 7.163 5 16 5s16-2.239 16-5v-4c0-2.761-7.163-5-16-5z"></path>
<path d="M16 17c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
<path d="M16 26c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
</symbol>
<symbol id="icon-file-text2" viewBox="0 0 32 32">
<path d="M28.681 7.159c-0.694-0.947-1.662-2.053-2.724-3.116s-2.169-2.030-3.116-2.724c-1.612-1.182-2.393-1.319-2.841-1.319h-15.5c-1.378 0-2.5 1.121-2.5 2.5v27c0 1.378 1.122 2.5 2.5 2.5h23c1.378 0 2.5-1.122 2.5-2.5v-19.5c0-0.448-0.137-1.23-1.319-2.841zM24.543 5.457c0.959 0.959 1.712 1.825 2.268 2.543h-4.811v-4.811c0.718 0.556 1.584 1.309 2.543 2.268zM28 29.5c0 0.271-0.229 0.5-0.5 0.5h-23c-0.271 0-0.5-0.229-0.5-0.5v-27c0-0.271 0.229-0.5 0.5-0.5 0 0 15.499-0 15.5 0v7c0 0.552 0.448 1 1 1h7v19.5z"></path>
<path d="M23 26h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 22h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 18h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
</symbol>
</defs>
</svg>
<style>/* CSS stylesheet for displaying xarray objects in jupyterlab.
 *
 */

:root {
  --xr-font-color0: var(--jp-content-font-color0, rgba(0, 0, 0, 1));
  --xr-font-color2: var(--jp-content-font-color2, rgba(0, 0, 0, 0.54));
  --xr-font-color3: var(--jp-content-font-color3, rgba(0, 0, 0, 0.38));
  --xr-border-color: var(--jp-border-color2, #e0e0e0);
  --xr-disabled-color: var(--jp-layout-color3, #bdbdbd);
  --xr-background-color: var(--jp-layout-color0, white);
  --xr-background-color-row-even: var(--jp-layout-color1, white);
  --xr-background-color-row-odd: var(--jp-layout-color2, #eeeeee);
}

html[theme=dark],
body.vscode-dark {
  --xr-font-color0: rgba(255, 255, 255, 1);
  --xr-font-color2: rgba(255, 255, 255, 0.54);
  --xr-font-color3: rgba(255, 255, 255, 0.38);
  --xr-border-color: #1F1F1F;
  --xr-disabled-color: #515151;
  --xr-background-color: #111111;
  --xr-background-color-row-even: #111111;
  --xr-background-color-row-odd: #313131;
}

.xr-wrap {
  display: block;
  min-width: 300px;
  max-width: 700px;
}

.xr-text-repr-fallback {
  /* fallback to plain text repr when CSS is not injected (untrusted notebook) */
  display: none;
}

.xr-header {
  padding-top: 6px;
  padding-bottom: 6px;
  margin-bottom: 4px;
  border-bottom: solid 1px var(--xr-border-color);
}

.xr-header > div,
.xr-header > ul {
  display: inline;
  margin-top: 0;
  margin-bottom: 0;
}

.xr-obj-type,
.xr-array-name {
  margin-left: 2px;
  margin-right: 10px;
}

.xr-obj-type {
  color: var(--xr-font-color2);
}

.xr-sections {
  padding-left: 0 !important;
  display: grid;
  grid-template-columns: 150px auto auto 1fr 20px 20px;
}

.xr-section-item {
  display: contents;
}

.xr-section-item input {
  display: none;
}

.xr-section-item input + label {
  color: var(--xr-disabled-color);
}

.xr-section-item input:enabled + label {
  cursor: pointer;
  color: var(--xr-font-color2);
}

.xr-section-item input:enabled + label:hover {
  color: var(--xr-font-color0);
}

.xr-section-summary {
  grid-column: 1;
  color: var(--xr-font-color2);
  font-weight: 500;
}

.xr-section-summary > span {
  display: inline-block;
  padding-left: 0.5em;
}

.xr-section-summary-in:disabled + label {
  color: var(--xr-font-color2);
}

.xr-section-summary-in + label:before {
  display: inline-block;
  content: 'â–º';
  font-size: 11px;
  width: 15px;
  text-align: center;
}

.xr-section-summary-in:disabled + label:before {
  color: var(--xr-disabled-color);
}

.xr-section-summary-in:checked + label:before {
  content: 'â–¼';
}

.xr-section-summary-in:checked + label > span {
  display: none;
}

.xr-section-summary,
.xr-section-inline-details {
  padding-top: 4px;
  padding-bottom: 4px;
}

.xr-section-inline-details {
  grid-column: 2 / -1;
}

.xr-section-details {
  display: none;
  grid-column: 1 / -1;
  margin-bottom: 5px;
}

.xr-section-summary-in:checked ~ .xr-section-details {
  display: contents;
}

.xr-array-wrap {
  grid-column: 1 / -1;
  display: grid;
  grid-template-columns: 20px auto;
}

.xr-array-wrap > label {
  grid-column: 1;
  vertical-align: top;
}

.xr-preview {
  color: var(--xr-font-color3);
}

.xr-array-preview,
.xr-array-data {
  padding: 0 5px !important;
  grid-column: 2;
}

.xr-array-data,
.xr-array-in:checked ~ .xr-array-preview {
  display: none;
}

.xr-array-in:checked ~ .xr-array-data,
.xr-array-preview {
  display: inline-block;
}

.xr-dim-list {
  display: inline-block !important;
  list-style: none;
  padding: 0 !important;
  margin: 0;
}

.xr-dim-list li {
  display: inline-block;
  padding: 0;
  margin: 0;
}

.xr-dim-list:before {
  content: '(';
}

.xr-dim-list:after {
  content: ')';
}

.xr-dim-list li:not(:last-child):after {
  content: ',';
  padding-right: 5px;
}

.xr-has-index {
  font-weight: bold;
}

.xr-var-list,
.xr-var-item {
  display: contents;
}

.xr-var-item > div,
.xr-var-item label,
.xr-var-item > .xr-var-name span {
  background-color: var(--xr-background-color-row-even);
  margin-bottom: 0;
}

.xr-var-item > .xr-var-name:hover span {
  padding-right: 5px;
}

.xr-var-list > li:nth-child(odd) > div,
.xr-var-list > li:nth-child(odd) > label,
.xr-var-list > li:nth-child(odd) > .xr-var-name span {
  background-color: var(--xr-background-color-row-odd);
}

.xr-var-name {
  grid-column: 1;
}

.xr-var-dims {
  grid-column: 2;
}

.xr-var-dtype {
  grid-column: 3;
  text-align: right;
  color: var(--xr-font-color2);
}

.xr-var-preview {
  grid-column: 4;
}

.xr-var-name,
.xr-var-dims,
.xr-var-dtype,
.xr-preview,
.xr-attrs dt {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  padding-right: 10px;
}

.xr-var-name:hover,
.xr-var-dims:hover,
.xr-var-dtype:hover,
.xr-attrs dt:hover {
  overflow: visible;
  width: auto;
  z-index: 1;
}

.xr-var-attrs,
.xr-var-data {
  display: none;
  background-color: var(--xr-background-color) !important;
  padding-bottom: 5px !important;
}

.xr-var-attrs-in:checked ~ .xr-var-attrs,
.xr-var-data-in:checked ~ .xr-var-data {
  display: block;
}

.xr-var-data > table {
  float: right;
}

.xr-var-name span,
.xr-var-data,
.xr-attrs {
  padding-left: 25px !important;
}

.xr-attrs,
.xr-var-attrs,
.xr-var-data {
  grid-column: 1 / -1;
}

dl.xr-attrs {
  padding: 0;
  margin: 0;
  display: grid;
  grid-template-columns: 125px auto;
}

.xr-attrs dt,
.xr-attrs dd {
  padding: 0;
  margin: 0;
  float: left;
  padding-right: 10px;
  width: auto;
}

.xr-attrs dt {
  font-weight: normal;
  grid-column: 1;
}

.xr-attrs dt:hover span {
  display: inline-block;
  background: var(--xr-background-color);
  padding-right: 10px;
}

.xr-attrs dd {
  grid-column: 2;
  white-space: pre-wrap;
  word-break: break-all;
}

.xr-icon-database,
.xr-icon-file-text2 {
  display: inline-block;
  vertical-align: middle;
  width: 1em;
  height: 1.5em !important;
  stroke-width: 0;
  stroke: currentColor;
  fill: currentColor;
}
</style><pre class='xr-text-repr-fallback'>&lt;xarray.DataArray &#x27;stacked_eumetsat_data&#x27; (variable: 12, y: 1831, x: 1870)&gt;
dask.array&lt;concatenate, shape=(12, 1831, 1870), dtype=float32, chunksize=(1, 1831, 1870), chunktype=numpy.ndarray&gt;
Coordinates:
  * y         (y) float64 9.012e+06 9.008e+06 9.004e+06 ... 1.696e+06 1.692e+06
  * x         (x) float64 -3.088e+06 -3.084e+06 ... 4.384e+06 4.388e+06
  * variable  (variable) object &#x27;HRV&#x27; &#x27;IR_016&#x27; &#x27;IR_039&#x27; ... &#x27;WV_062&#x27; &#x27;WV_073&#x27;
Attributes:
    orbital_parameters:                     {&#x27;projection_longitude&#x27;: 9.5, &#x27;pr...
    sun_earth_distance_correction_applied:  True
    sun_earth_distance_correction_factor:   0.9911189780118609
    units:                                  %
    wavelength:                             0.7â€¯ÂµmÂ (0.5-0.9â€¯Âµm)
    standard_name:                          toa_bidirectional_reflectance
    platform_name:                          Meteosat-10
    sensor:                                 seviri
    start_time:                             2021-03-19 13:15:09.278906
    end_time:                               2021-03-19 13:20:10.330158
    area:                                   Area ID: geos_seviri_hrv\nDescrip...
    name:                                   HRV
    resolution:                             1000.134348869
    calibration:                            reflectance
    modifiers:                              ()
    _satpy_id:                              DataID(name=&#x27;HRV&#x27;, wavelength=Wav...
    ancillary_variables:                    []</pre><div class='xr-wrap' hidden><div class='xr-header'><div class='xr-obj-type'>xarray.DataArray</div><div class='xr-array-name'>'stacked_eumetsat_data'</div><ul class='xr-dim-list'><li><span class='xr-has-index'>variable</span>: 12</li><li><span class='xr-has-index'>y</span>: 1831</li><li><span class='xr-has-index'>x</span>: 1870</li></ul></div><ul class='xr-sections'><li class='xr-section-item'><div class='xr-array-wrap'><input id='section-3df9f2ff-85ef-4246-859b-aafd2fbc6d16' class='xr-array-in' type='checkbox' checked><label for='section-3df9f2ff-85ef-4246-859b-aafd2fbc6d16' title='Show/hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-array-preview xr-preview'><span>dask.array&lt;chunksize=(1, 1831, 1870), meta=np.ndarray&gt;</span></div><div class='xr-array-data'><table>
<tr>
<td>
<table>
  <thead>
    <tr><td> </td><th> Array </th><th> Chunk </th></tr>
  </thead>
  <tbody>
    <tr><th> Bytes </th><td> 164.35 MB </td> <td> 13.70 MB </td></tr>
    <tr><th> Shape </th><td> (12, 1831, 1870) </td> <td> (1, 1831, 1870) </td></tr>
    <tr><th> Count </th><td> 1335 Tasks </td><td> 12 Chunks </td></tr>
    <tr><th> Type </th><td> float32 </td><td> numpy.ndarray </td></tr>
  </tbody>
</table>
</td>
<td>
<svg width="194" height="182" style="stroke:rgb(0,0,0);stroke-width:1" >

  <!-- Horizontal lines -->
  <line x1="10" y1="0" x2="24" y2="14" style="stroke-width:2" />
  <line x1="10" y1="117" x2="24" y2="132" style="stroke-width:2" />

  <!-- Vertical lines -->
  <line x1="10" y1="0" x2="10" y2="117" style="stroke-width:2" />
  <line x1="11" y1="1" x2="11" y2="118" />
  <line x1="12" y1="2" x2="12" y2="119" />
  <line x1="13" y1="3" x2="13" y2="121" />
  <line x1="14" y1="4" x2="14" y2="122" />
  <line x1="16" y1="6" x2="16" y2="123" />
  <line x1="17" y1="7" x2="17" y2="124" />
  <line x1="18" y1="8" x2="18" y2="126" />
  <line x1="19" y1="9" x2="19" y2="127" />
  <line x1="21" y1="11" x2="21" y2="128" />
  <line x1="22" y1="12" x2="22" y2="129" />
  <line x1="23" y1="13" x2="23" y2="131" />
  <line x1="24" y1="14" x2="24" y2="132" style="stroke-width:2" />

  <!-- Colored Rectangle -->
  <polygon points="10.0,0.0 24.9485979497544,14.948597949754403 24.9485979497544,132.44592415296296 10.0,117.49732620320856" style="fill:#ECB172A0;stroke-width:0"/>

  <!-- Horizontal lines -->
  <line x1="10" y1="0" x2="130" y2="0" style="stroke-width:2" />
  <line x1="11" y1="1" x2="131" y2="1" />
  <line x1="12" y1="2" x2="132" y2="2" />
  <line x1="13" y1="3" x2="133" y2="3" />
  <line x1="14" y1="4" x2="134" y2="4" />
  <line x1="16" y1="6" x2="136" y2="6" />
  <line x1="17" y1="7" x2="137" y2="7" />
  <line x1="18" y1="8" x2="138" y2="8" />
  <line x1="19" y1="9" x2="139" y2="9" />
  <line x1="21" y1="11" x2="141" y2="11" />
  <line x1="22" y1="12" x2="142" y2="12" />
  <line x1="23" y1="13" x2="143" y2="13" />
  <line x1="24" y1="14" x2="144" y2="14" style="stroke-width:2" />

  <!-- Vertical lines -->
  <line x1="10" y1="0" x2="24" y2="14" style="stroke-width:2" />
  <line x1="130" y1="0" x2="144" y2="14" style="stroke-width:2" />

  <!-- Colored Rectangle -->
  <polygon points="10.0,0.0 130.0,0.0 144.9485979497544,14.948597949754403 24.9485979497544,14.948597949754403" style="fill:#ECB172A0;stroke-width:0"/>

  <!-- Horizontal lines -->
  <line x1="24" y1="14" x2="144" y2="14" style="stroke-width:2" />
  <line x1="24" y1="132" x2="144" y2="132" style="stroke-width:2" />

  <!-- Vertical lines -->
  <line x1="24" y1="14" x2="24" y2="132" style="stroke-width:2" />
  <line x1="144" y1="14" x2="144" y2="132" style="stroke-width:2" />

  <!-- Colored Rectangle -->
  <polygon points="24.9485979497544,14.948597949754403 144.9485979497544,14.948597949754403 144.9485979497544,132.44592415296296 24.9485979497544,132.44592415296296" style="fill:#ECB172A0;stroke-width:0"/>

  <!-- Text -->
  <text x="84.948598" y="152.445924" font-size="1.0rem" font-weight="100" text-anchor="middle" >1870</text>
  <text x="164.948598" y="73.697261" font-size="1.0rem" font-weight="100" text-anchor="middle" transform="rotate(-90,164.948598,73.697261)">1831</text>
  <text x="7.474299" y="144.971625" font-size="1.0rem" font-weight="100" text-anchor="middle" transform="rotate(45,7.474299,144.971625)">12</text>
</svg>
</td>
</tr>
</table></div></div></li><li class='xr-section-item'><input id='section-d1b355e6-0474-4e22-b2d5-204f8e74f124' class='xr-section-summary-in' type='checkbox'  checked><label for='section-d1b355e6-0474-4e22-b2d5-204f8e74f124' class='xr-section-summary' >Coordinates: <span>(3)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><ul class='xr-var-list'><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>y</span></div><div class='xr-var-dims'>(y)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>9.012e+06 9.008e+06 ... 1.692e+06</div><input id='attrs-15760121-21cc-4783-8c64-5b87a7b6a81a' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-15760121-21cc-4783-8c64-5b87a7b6a81a' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-5fa89cd5-46c2-4631-a2c0-bc52e0d511cf' class='xr-var-data-in' type='checkbox'><label for='data-5fa89cd5-46c2-4631-a2c0-bc52e0d511cf' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([9012000., 9008000., 9004000., ..., 1700000., 1696000., 1692000.])</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>x</span></div><div class='xr-var-dims'>(x)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>-3.088e+06 -3.084e+06 ... 4.388e+06</div><input id='attrs-5298ee29-2ee1-40fc-8db6-cdf108376caf' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-5298ee29-2ee1-40fc-8db6-cdf108376caf' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-47d5e03c-34a6-40b6-840c-c5f3a895be33' class='xr-var-data-in' type='checkbox'><label for='data-47d5e03c-34a6-40b6-840c-c5f3a895be33' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([-3088000., -3084000., -3080000., ...,  4380000.,  4384000.,  4388000.])</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>variable</span></div><div class='xr-var-dims'>(variable)</div><div class='xr-var-dtype'>object</div><div class='xr-var-preview xr-preview'>&#x27;HRV&#x27; &#x27;IR_016&#x27; ... &#x27;WV_073&#x27;</div><input id='attrs-3df88dae-8221-4559-b8b6-1d25e67e5c92' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-3df88dae-8221-4559-b8b6-1d25e67e5c92' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-4a0dad21-2c1a-43c4-b4ec-e2e7804bc5d5' class='xr-var-data-in' type='checkbox'><label for='data-4a0dad21-2c1a-43c4-b4ec-e2e7804bc5d5' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([&#x27;HRV&#x27;, &#x27;IR_016&#x27;, &#x27;IR_039&#x27;, &#x27;IR_087&#x27;, &#x27;IR_097&#x27;, &#x27;IR_108&#x27;, &#x27;IR_120&#x27;,
       &#x27;IR_134&#x27;, &#x27;VIS006&#x27;, &#x27;VIS008&#x27;, &#x27;WV_062&#x27;, &#x27;WV_073&#x27;], dtype=object)</pre></div></li></ul></div></li><li class='xr-section-item'><input id='section-e65ae250-3998-4049-8874-484ec6845b14' class='xr-section-summary-in' type='checkbox'  ><label for='section-e65ae250-3998-4049-8874-484ec6845b14' class='xr-section-summary' >Attributes: <span>(17)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><dl class='xr-attrs'><dt><span>orbital_parameters :</span></dt><dd>{&#x27;projection_longitude&#x27;: 9.5, &#x27;projection_latitude&#x27;: 0.0, &#x27;projection_altitude&#x27;: 35785831.0}</dd><dt><span>sun_earth_distance_correction_applied :</span></dt><dd>True</dd><dt><span>sun_earth_distance_correction_factor :</span></dt><dd>0.9911189780118609</dd><dt><span>units :</span></dt><dd>%</dd><dt><span>wavelength :</span></dt><dd>0.7â€¯ÂµmÂ (0.5-0.9â€¯Âµm)</dd><dt><span>standard_name :</span></dt><dd>toa_bidirectional_reflectance</dd><dt><span>platform_name :</span></dt><dd>Meteosat-10</dd><dt><span>sensor :</span></dt><dd>seviri</dd><dt><span>start_time :</span></dt><dd>2021-03-19 13:15:09.278906</dd><dt><span>end_time :</span></dt><dd>2021-03-19 13:20:10.330158</dd><dt><span>area :</span></dt><dd>Area ID: geos_seviri_hrv
Description: SEVIRI high resolution channel area
Projection ID: seviri_hrv
Projection: {&#x27;a&#x27;: &#x27;6378169&#x27;, &#x27;h&#x27;: &#x27;35785831&#x27;, &#x27;lon_0&#x27;: &#x27;9.5&#x27;, &#x27;no_defs&#x27;: &#x27;None&#x27;, &#x27;proj&#x27;: &#x27;geos&#x27;, &#x27;rf&#x27;: &#x27;295.488065897014&#x27;, &#x27;type&#x27;: &#x27;crs&#x27;, &#x27;units&#x27;: &#x27;m&#x27;, &#x27;x_0&#x27;: &#x27;0&#x27;, &#x27;y_0&#x27;: &#x27;0&#x27;}
Number of columns: 5568
Number of rows: 4176
Area extent: (2790874.9005, 5571248.3904, -2777873.154, 1394687.3495)</dd><dt><span>name :</span></dt><dd>HRV</dd><dt><span>resolution :</span></dt><dd>1000.134348869</dd><dt><span>calibration :</span></dt><dd>reflectance</dd><dt><span>modifiers :</span></dt><dd>()</dd><dt><span>_satpy_id :</span></dt><dd>DataID(name=&#x27;HRV&#x27;, wavelength=WavelengthRange(min=0.5, central=0.7, max=0.9, unit=&#x27;Âµm&#x27;), resolution=1000.134348869, calibration=&lt;calibration.reflectance&gt;, modifiers=())</dd><dt><span>ancillary_variables :</span></dt><dd>[]</dd></dl></div></li></ul></div></div>

<p><br></p>
<h3 id="compressing">Compressing<a class="headerlink" href="#compressing" title="Permanent link">&para;</a></h3>
<p>We'll now develop our compressor class that will reduce the size of the datasets that we save to Zarr, in this instance we'll normalize the data and transform it to Int16. This has been found to reduce the size by ~50%.</p>
<div class="highlight"><pre><span></span><code><span class="c1">#exports</span>
<span class="k">def</span> <span class="nf">add_constant_coord_to_da</span><span class="p">(</span><span class="n">da</span><span class="p">,</span> <span class="n">coord_name</span><span class="p">,</span> <span class="n">coord_val</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adds a new coordinate with a </span>
<span class="sd">    constant value to the DataArray</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    da : xr.DataArray</span>
<span class="sd">        DataArrray which will have the new coords added to it</span>
<span class="sd">    coord_name : str</span>
<span class="sd">        Name for the new coordinate dimensions</span>
<span class="sd">    coord_val</span>
<span class="sd">        Value that will be assigned to the new coordinates</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    da : xr.DataArray</span>
<span class="sd">        DataArrray with the new coords added to it</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">da</span> <span class="o">=</span> <span class="p">(</span><span class="n">da</span>
          <span class="o">.</span><span class="n">assign_coords</span><span class="p">({</span><span class="n">coord_name</span><span class="p">:</span><span class="n">coord_val</span><span class="p">})</span>
          <span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">coord_name</span><span class="p">)</span>
         <span class="p">)</span>

    <span class="k">return</span> <span class="n">da</span>

<span class="k">class</span> <span class="nc">Compressor</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                 <span class="n">bits_per_pixel</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> 
                 <span class="n">mins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">1.2278595</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.5118103</span><span class="p">,</span> <span class="o">-</span><span class="mf">64.83977</span><span class="p">,</span> <span class="mf">63.404694</span><span class="p">,</span> <span class="mf">2.844452</span><span class="p">,</span> <span class="mf">199.10002</span><span class="p">,</span> <span class="o">-</span><span class="mf">17.254883</span><span class="p">,</span> <span class="o">-</span><span class="mf">26.29155</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.1009827</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.4184198</span><span class="p">,</span> <span class="mf">199.57048</span><span class="p">,</span> <span class="mf">198.95093</span><span class="p">]),</span> 
                 <span class="n">maxs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">103.90016</span><span class="p">,</span> <span class="mf">69.60857</span><span class="p">,</span> <span class="mf">339.15588</span><span class="p">,</span> <span class="mf">340.26526</span><span class="p">,</span> <span class="mf">317.86752</span><span class="p">,</span> <span class="mf">313.2767</span><span class="p">,</span> <span class="mf">315.99194</span><span class="p">,</span> <span class="mf">274.82297</span><span class="p">,</span> <span class="mf">93.786545</span><span class="p">,</span> <span class="mf">101.34922</span><span class="p">,</span> <span class="mf">249.91806</span><span class="p">,</span> <span class="mf">286.96323</span><span class="p">]),</span>
                 <span class="n">variable_order</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;HRV&#39;</span><span class="p">,</span> <span class="s1">&#39;IR_016&#39;</span><span class="p">,</span> <span class="s1">&#39;IR_039&#39;</span><span class="p">,</span> <span class="s1">&#39;IR_087&#39;</span><span class="p">,</span> <span class="s1">&#39;IR_097&#39;</span><span class="p">,</span> <span class="s1">&#39;IR_108&#39;</span><span class="p">,</span> <span class="s1">&#39;IR_120&#39;</span><span class="p">,</span> <span class="s1">&#39;IR_134&#39;</span><span class="p">,</span> <span class="s1">&#39;VIS006&#39;</span><span class="p">,</span> <span class="s1">&#39;VIS008&#39;</span><span class="p">,</span> <span class="s1">&#39;WV_062&#39;</span><span class="p">,</span> <span class="s1">&#39;WV_073&#39;</span><span class="p">]</span>
                <span class="p">):</span>

        <span class="n">locals_</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()</span>
        <span class="n">attrs_to_add</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;bits_per_pixel&#39;</span><span class="p">,</span> <span class="s1">&#39;mins&#39;</span><span class="p">,</span> <span class="s1">&#39;maxs&#39;</span><span class="p">,</span> <span class="s1">&#39;variable_order&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs_to_add</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">locals_</span><span class="p">[</span><span class="n">attr</span><span class="p">])</span>

        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">da</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mins</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">dims</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxs</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">dims</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">variable_order</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The mins are: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mins</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The maxs are: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">maxs</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The variable order is: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">variable_order</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">compress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">da</span><span class="p">):</span>
        <span class="n">da_meta</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">attrs</span> 

        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;mins&#39;</span><span class="p">,</span> <span class="s1">&#39;maxs&#39;</span><span class="p">]:</span>
            <span class="k">assert</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s1"> must be set in initialisation or through `fit`&#39;</span>

        <span class="k">if</span> <span class="s1">&#39;time&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">da</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
            <span class="n">time</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">da_meta</span><span class="p">[</span><span class="s1">&#39;end_time&#39;</span><span class="p">])</span>
            <span class="n">da</span> <span class="o">=</span> <span class="n">add_constant_coord_to_da</span><span class="p">(</span><span class="n">da</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>

        <span class="n">da</span> <span class="o">=</span> <span class="p">(</span><span class="n">da</span>
              <span class="o">.</span><span class="n">reindex</span><span class="p">({</span><span class="s1">&#39;variable&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">variable_order</span><span class="p">})</span>
              <span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;variable&#39;</span><span class="p">)</span>
             <span class="p">)</span>

        <span class="n">upper_bound</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="bp">self</span><span class="o">.</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">new_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxs</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">mins</span>

        <span class="n">da</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mins</span>
        <span class="n">da</span> <span class="o">/=</span> <span class="n">new_max</span>
        <span class="n">da</span> <span class="o">*=</span> <span class="n">upper_bound</span>

        <span class="n">da</span> <span class="o">=</span> <span class="p">(</span><span class="n">da</span>
              <span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">upper_bound</span><span class="p">)</span>
              <span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
              <span class="o">.</span><span class="n">round</span><span class="p">()</span>
              <span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
             <span class="p">)</span>

        <span class="n">da</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;meta&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">da_meta</span><span class="p">)}</span> <span class="c1"># Must be serialisable</span>

        <span class="k">return</span> <span class="n">da</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="o">%%</span><span class="n">time</span>

<span class="n">compressor</span> <span class="o">=</span> <span class="n">Compressor</span><span class="p">()</span>

<span class="n">da_compressed</span> <span class="o">=</span> <span class="n">compressor</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">ds_reproj</span><span class="p">[</span><span class="s1">&#39;stacked_eumetsat_data&#39;</span><span class="p">])</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>CPU times: user 10.7 ms, sys: 1.96 ms, total: 12.7 ms
Wall time: 12.6 ms
</code></pre></div>
<p><br></p>
<h3 id="saving-to-zarr">Saving to Zarr<a class="headerlink" href="#saving-to-zarr" title="Permanent link">&para;</a></h3>
<p>We'll now create a helper function for saving the data-array to a zarr database</p>
<div class="highlight"><pre><span></span><code><span class="c1"># exports</span>
<span class="n">get_time_as_unix</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">da</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">((</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">da</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;1970-01-01&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">())</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>

<span class="k">def</span> <span class="nf">save_da_to_zarr</span><span class="p">(</span><span class="n">da</span><span class="p">,</span> <span class="n">zarr_bucket</span><span class="p">,</span> <span class="n">dim_order</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;variable&#39;</span><span class="p">],</span> <span class="n">zarr_mode</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">):</span>
    <span class="n">da</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="o">*</span><span class="n">dim_order</span><span class="p">)</span>
    <span class="n">da</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_time_as_unix</span><span class="p">(</span><span class="n">da</span><span class="p">)</span>

    <span class="n">_</span><span class="p">,</span> <span class="n">y_size</span><span class="p">,</span> <span class="n">x_size</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">out_store</span> <span class="o">=</span> <span class="n">gcsfs</span><span class="o">.</span><span class="n">GCSMap</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="n">zarr_bucket</span><span class="p">,</span> <span class="n">gcs</span><span class="o">=</span><span class="n">gcsfs</span><span class="o">.</span><span class="n">GCSFileSystem</span><span class="p">())</span>

    <span class="n">chunks</span> <span class="o">=</span> <span class="p">(</span><span class="mi">36</span><span class="p">,</span> <span class="n">y_size</span><span class="p">,</span> <span class="n">x_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">({</span><span class="s1">&#39;stacked_eumetsat_data&#39;</span><span class="p">:</span> <span class="n">da</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">chunks</span><span class="p">)})</span>

    <span class="n">zarr_mode_to_extra_kwargs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;append_dim&#39;</span><span class="p">:</span> <span class="s1">&#39;time&#39;</span>
        <span class="p">},</span>
        <span class="s1">&#39;w&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;encoding&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;stacked_eumetsat_data&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;compressor&#39;</span><span class="p">:</span> <span class="n">numcodecs</span><span class="o">.</span><span class="n">Blosc</span><span class="p">(</span><span class="n">cname</span><span class="o">=</span><span class="s1">&#39;zstd&#39;</span><span class="p">,</span> <span class="n">clevel</span><span class="o">=</span><span class="mi">5</span><span class="p">),</span>
                    <span class="s1">&#39;chunks&#39;</span><span class="p">:</span> <span class="n">chunks</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">assert</span> <span class="n">zarr_mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">],</span> <span class="s1">&#39;`zarr_mode` must be one of: `a`, `w`&#39;</span>
    <span class="n">extra_kwargs</span> <span class="o">=</span> <span class="n">zarr_mode_to_extra_kwargs</span><span class="p">[</span><span class="n">zarr_mode</span><span class="p">]</span>

    <span class="n">ds</span><span class="o">.</span><span class="n">to_zarr</span><span class="p">(</span><span class="n">out_store</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">zarr_mode</span><span class="p">,</span> <span class="n">consolidated</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">extra_kwargs</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Saved file to zarr bucket&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ds</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">da_compressed</span>
</code></pre></div>
<div><svg style="position: absolute; width: 0; height: 0; overflow: hidden">
<defs>
<symbol id="icon-database" viewBox="0 0 32 32">
<path d="M16 0c-8.837 0-16 2.239-16 5v4c0 2.761 7.163 5 16 5s16-2.239 16-5v-4c0-2.761-7.163-5-16-5z"></path>
<path d="M16 17c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
<path d="M16 26c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
</symbol>
<symbol id="icon-file-text2" viewBox="0 0 32 32">
<path d="M28.681 7.159c-0.694-0.947-1.662-2.053-2.724-3.116s-2.169-2.030-3.116-2.724c-1.612-1.182-2.393-1.319-2.841-1.319h-15.5c-1.378 0-2.5 1.121-2.5 2.5v27c0 1.378 1.122 2.5 2.5 2.5h23c1.378 0 2.5-1.122 2.5-2.5v-19.5c0-0.448-0.137-1.23-1.319-2.841zM24.543 5.457c0.959 0.959 1.712 1.825 2.268 2.543h-4.811v-4.811c0.718 0.556 1.584 1.309 2.543 2.268zM28 29.5c0 0.271-0.229 0.5-0.5 0.5h-23c-0.271 0-0.5-0.229-0.5-0.5v-27c0-0.271 0.229-0.5 0.5-0.5 0 0 15.499-0 15.5 0v7c0 0.552 0.448 1 1 1h7v19.5z"></path>
<path d="M23 26h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 22h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 18h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
</symbol>
</defs>
</svg>
<style>/* CSS stylesheet for displaying xarray objects in jupyterlab.
 *
 */

:root {
  --xr-font-color0: var(--jp-content-font-color0, rgba(0, 0, 0, 1));
  --xr-font-color2: var(--jp-content-font-color2, rgba(0, 0, 0, 0.54));
  --xr-font-color3: var(--jp-content-font-color3, rgba(0, 0, 0, 0.38));
  --xr-border-color: var(--jp-border-color2, #e0e0e0);
  --xr-disabled-color: var(--jp-layout-color3, #bdbdbd);
  --xr-background-color: var(--jp-layout-color0, white);
  --xr-background-color-row-even: var(--jp-layout-color1, white);
  --xr-background-color-row-odd: var(--jp-layout-color2, #eeeeee);
}

html[theme=dark],
body.vscode-dark {
  --xr-font-color0: rgba(255, 255, 255, 1);
  --xr-font-color2: rgba(255, 255, 255, 0.54);
  --xr-font-color3: rgba(255, 255, 255, 0.38);
  --xr-border-color: #1F1F1F;
  --xr-disabled-color: #515151;
  --xr-background-color: #111111;
  --xr-background-color-row-even: #111111;
  --xr-background-color-row-odd: #313131;
}

.xr-wrap {
  display: block;
  min-width: 300px;
  max-width: 700px;
}

.xr-text-repr-fallback {
  /* fallback to plain text repr when CSS is not injected (untrusted notebook) */
  display: none;
}

.xr-header {
  padding-top: 6px;
  padding-bottom: 6px;
  margin-bottom: 4px;
  border-bottom: solid 1px var(--xr-border-color);
}

.xr-header > div,
.xr-header > ul {
  display: inline;
  margin-top: 0;
  margin-bottom: 0;
}

.xr-obj-type,
.xr-array-name {
  margin-left: 2px;
  margin-right: 10px;
}

.xr-obj-type {
  color: var(--xr-font-color2);
}

.xr-sections {
  padding-left: 0 !important;
  display: grid;
  grid-template-columns: 150px auto auto 1fr 20px 20px;
}

.xr-section-item {
  display: contents;
}

.xr-section-item input {
  display: none;
}

.xr-section-item input + label {
  color: var(--xr-disabled-color);
}

.xr-section-item input:enabled + label {
  cursor: pointer;
  color: var(--xr-font-color2);
}

.xr-section-item input:enabled + label:hover {
  color: var(--xr-font-color0);
}

.xr-section-summary {
  grid-column: 1;
  color: var(--xr-font-color2);
  font-weight: 500;
}

.xr-section-summary > span {
  display: inline-block;
  padding-left: 0.5em;
}

.xr-section-summary-in:disabled + label {
  color: var(--xr-font-color2);
}

.xr-section-summary-in + label:before {
  display: inline-block;
  content: 'â–º';
  font-size: 11px;
  width: 15px;
  text-align: center;
}

.xr-section-summary-in:disabled + label:before {
  color: var(--xr-disabled-color);
}

.xr-section-summary-in:checked + label:before {
  content: 'â–¼';
}

.xr-section-summary-in:checked + label > span {
  display: none;
}

.xr-section-summary,
.xr-section-inline-details {
  padding-top: 4px;
  padding-bottom: 4px;
}

.xr-section-inline-details {
  grid-column: 2 / -1;
}

.xr-section-details {
  display: none;
  grid-column: 1 / -1;
  margin-bottom: 5px;
}

.xr-section-summary-in:checked ~ .xr-section-details {
  display: contents;
}

.xr-array-wrap {
  grid-column: 1 / -1;
  display: grid;
  grid-template-columns: 20px auto;
}

.xr-array-wrap > label {
  grid-column: 1;
  vertical-align: top;
}

.xr-preview {
  color: var(--xr-font-color3);
}

.xr-array-preview,
.xr-array-data {
  padding: 0 5px !important;
  grid-column: 2;
}

.xr-array-data,
.xr-array-in:checked ~ .xr-array-preview {
  display: none;
}

.xr-array-in:checked ~ .xr-array-data,
.xr-array-preview {
  display: inline-block;
}

.xr-dim-list {
  display: inline-block !important;
  list-style: none;
  padding: 0 !important;
  margin: 0;
}

.xr-dim-list li {
  display: inline-block;
  padding: 0;
  margin: 0;
}

.xr-dim-list:before {
  content: '(';
}

.xr-dim-list:after {
  content: ')';
}

.xr-dim-list li:not(:last-child):after {
  content: ',';
  padding-right: 5px;
}

.xr-has-index {
  font-weight: bold;
}

.xr-var-list,
.xr-var-item {
  display: contents;
}

.xr-var-item > div,
.xr-var-item label,
.xr-var-item > .xr-var-name span {
  background-color: var(--xr-background-color-row-even);
  margin-bottom: 0;
}

.xr-var-item > .xr-var-name:hover span {
  padding-right: 5px;
}

.xr-var-list > li:nth-child(odd) > div,
.xr-var-list > li:nth-child(odd) > label,
.xr-var-list > li:nth-child(odd) > .xr-var-name span {
  background-color: var(--xr-background-color-row-odd);
}

.xr-var-name {
  grid-column: 1;
}

.xr-var-dims {
  grid-column: 2;
}

.xr-var-dtype {
  grid-column: 3;
  text-align: right;
  color: var(--xr-font-color2);
}

.xr-var-preview {
  grid-column: 4;
}

.xr-var-name,
.xr-var-dims,
.xr-var-dtype,
.xr-preview,
.xr-attrs dt {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  padding-right: 10px;
}

.xr-var-name:hover,
.xr-var-dims:hover,
.xr-var-dtype:hover,
.xr-attrs dt:hover {
  overflow: visible;
  width: auto;
  z-index: 1;
}

.xr-var-attrs,
.xr-var-data {
  display: none;
  background-color: var(--xr-background-color) !important;
  padding-bottom: 5px !important;
}

.xr-var-attrs-in:checked ~ .xr-var-attrs,
.xr-var-data-in:checked ~ .xr-var-data {
  display: block;
}

.xr-var-data > table {
  float: right;
}

.xr-var-name span,
.xr-var-data,
.xr-attrs {
  padding-left: 25px !important;
}

.xr-attrs,
.xr-var-attrs,
.xr-var-data {
  grid-column: 1 / -1;
}

dl.xr-attrs {
  padding: 0;
  margin: 0;
  display: grid;
  grid-template-columns: 125px auto;
}

.xr-attrs dt,
.xr-attrs dd {
  padding: 0;
  margin: 0;
  float: left;
  padding-right: 10px;
  width: auto;
}

.xr-attrs dt {
  font-weight: normal;
  grid-column: 1;
}

.xr-attrs dt:hover span {
  display: inline-block;
  background: var(--xr-background-color);
  padding-right: 10px;
}

.xr-attrs dd {
  grid-column: 2;
  white-space: pre-wrap;
  word-break: break-all;
}

.xr-icon-database,
.xr-icon-file-text2 {
  display: inline-block;
  vertical-align: middle;
  width: 1em;
  height: 1.5em !important;
  stroke-width: 0;
  stroke: currentColor;
  fill: currentColor;
}
</style><pre class='xr-text-repr-fallback'>&lt;xarray.DataArray &#x27;stacked_eumetsat_data&#x27; (time: 1, y: 1831, x: 1870, variable: 12)&gt;
dask.array&lt;astype, shape=(1, 1831, 1870, 12), dtype=int16, chunksize=(1, 1831, 1870, 1), chunktype=numpy.ndarray&gt;
Coordinates:
  * variable  (variable) object &#x27;HRV&#x27; &#x27;IR_016&#x27; &#x27;IR_039&#x27; ... &#x27;WV_062&#x27; &#x27;WV_073&#x27;
  * y         (y) float64 9.012e+06 9.008e+06 9.004e+06 ... 1.696e+06 1.692e+06
  * x         (x) float64 -3.088e+06 -3.084e+06 ... 4.384e+06 4.388e+06
  * time      (time) datetime64[ns] 2021-03-19T13:20:10.330158
Attributes:
    meta:     {&#x27;orbital_parameters&#x27;: {&#x27;projection_longitude&#x27;: 9.5, &#x27;projectio...</pre><div class='xr-wrap' hidden><div class='xr-header'><div class='xr-obj-type'>xarray.DataArray</div><div class='xr-array-name'>'stacked_eumetsat_data'</div><ul class='xr-dim-list'><li><span class='xr-has-index'>time</span>: 1</li><li><span class='xr-has-index'>y</span>: 1831</li><li><span class='xr-has-index'>x</span>: 1870</li><li><span class='xr-has-index'>variable</span>: 12</li></ul></div><ul class='xr-sections'><li class='xr-section-item'><div class='xr-array-wrap'><input id='section-fcaec95c-4579-42a5-8082-5af90766ace4' class='xr-array-in' type='checkbox' checked><label for='section-fcaec95c-4579-42a5-8082-5af90766ace4' title='Show/hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-array-preview xr-preview'><span>dask.array&lt;chunksize=(1, 1831, 1870, 1), meta=np.ndarray&gt;</span></div><div class='xr-array-data'><table>
<tr>
<td>
<table>
  <thead>
    <tr><td> </td><th> Array </th><th> Chunk </th></tr>
  </thead>
  <tbody>
    <tr><th> Bytes </th><td> 82.18 MB </td> <td> 6.85 MB </td></tr>
    <tr><th> Shape </th><td> (1, 1831, 1870, 12) </td> <td> (1, 1831, 1870, 1) </td></tr>
    <tr><th> Count </th><td> 1505 Tasks </td><td> 12 Chunks </td></tr>
    <tr><th> Type </th><td> int16 </td><td> numpy.ndarray </td></tr>
  </tbody>
</table>
</td>
<td>
<svg width="334" height="239" style="stroke:rgb(0,0,0);stroke-width:1" >

  <!-- Horizontal lines -->
  <line x1="0" y1="0" x2="25" y2="0" style="stroke-width:2" />
  <line x1="0" y1="25" x2="25" y2="25" style="stroke-width:2" />

  <!-- Vertical lines -->
  <line x1="0" y1="0" x2="0" y2="25" style="stroke-width:2" />
  <line x1="25" y1="0" x2="25" y2="25" style="stroke-width:2" />

  <!-- Colored Rectangle -->
  <polygon points="0.0,0.0 25.412616514582485,0.0 25.412616514582485,25.412616514582485 0.0,25.412616514582485" style="fill:#ECB172A0;stroke-width:0"/>

  <!-- Text -->
  <text x="12.706308" y="45.412617" font-size="1.0rem" font-weight="100" text-anchor="middle" >1</text>
  <text x="45.412617" y="12.706308" font-size="1.0rem" font-weight="100" text-anchor="middle" transform="rotate(0,45.412617,12.706308)">1</text>


  <!-- Horizontal lines -->
  <line x1="95" y1="0" x2="164" y2="69" style="stroke-width:2" />
  <line x1="95" y1="120" x2="164" y2="189" style="stroke-width:2" />

  <!-- Vertical lines -->
  <line x1="95" y1="0" x2="95" y2="120" style="stroke-width:2" />
  <line x1="164" y1="69" x2="164" y2="189" style="stroke-width:2" />

  <!-- Colored Rectangle -->
  <polygon points="95.0,0.0 164.11607423718152,69.11607423718151 164.11607423718152,189.11607423718152 95.0,120.0" style="fill:#ECB172A0;stroke-width:0"/>

  <!-- Horizontal lines -->
  <line x1="95" y1="0" x2="120" y2="0" style="stroke-width:2" />
  <line x1="164" y1="69" x2="189" y2="69" style="stroke-width:2" />

  <!-- Vertical lines -->
  <line x1="95" y1="0" x2="164" y2="69" style="stroke-width:2" />
  <line x1="97" y1="0" x2="166" y2="69" />
  <line x1="99" y1="0" x2="168" y2="69" />
  <line x1="101" y1="0" x2="170" y2="69" />
  <line x1="103" y1="0" x2="172" y2="69" />
  <line x1="105" y1="0" x2="174" y2="69" />
  <line x1="107" y1="0" x2="176" y2="69" />
  <line x1="109" y1="0" x2="178" y2="69" />
  <line x1="111" y1="0" x2="181" y2="69" />
  <line x1="114" y1="0" x2="183" y2="69" />
  <line x1="116" y1="0" x2="185" y2="69" />
  <line x1="118" y1="0" x2="187" y2="69" />
  <line x1="120" y1="0" x2="189" y2="69" style="stroke-width:2" />

  <!-- Colored Rectangle -->
  <polygon points="95.0,0.0 120.41261651458248,0.0 189.52869075176397,69.11607423718151 164.11607423718152,69.11607423718151" style="fill:#ECB172A0;stroke-width:0"/>

  <!-- Horizontal lines -->
  <line x1="164" y1="69" x2="189" y2="69" style="stroke-width:2" />
  <line x1="164" y1="189" x2="189" y2="189" style="stroke-width:2" />

  <!-- Vertical lines -->
  <line x1="164" y1="69" x2="164" y2="189" style="stroke-width:2" />
  <line x1="166" y1="69" x2="166" y2="189" />
  <line x1="168" y1="69" x2="168" y2="189" />
  <line x1="170" y1="69" x2="170" y2="189" />
  <line x1="172" y1="69" x2="172" y2="189" />
  <line x1="174" y1="69" x2="174" y2="189" />
  <line x1="176" y1="69" x2="176" y2="189" />
  <line x1="178" y1="69" x2="178" y2="189" />
  <line x1="181" y1="69" x2="181" y2="189" />
  <line x1="183" y1="69" x2="183" y2="189" />
  <line x1="185" y1="69" x2="185" y2="189" />
  <line x1="187" y1="69" x2="187" y2="189" />
  <line x1="189" y1="69" x2="189" y2="189" style="stroke-width:2" />

  <!-- Colored Rectangle -->
  <polygon points="164.11607423718152,69.11607423718151 189.528690751764,69.11607423718151 189.528690751764,189.11607423718152 164.11607423718152,189.11607423718152" style="fill:#ECB172A0;stroke-width:0"/>

  <!-- Text -->
  <text x="176.822382" y="209.116074" font-size="1.0rem" font-weight="100" text-anchor="middle" >12</text>
  <text x="209.528691" y="129.116074" font-size="1.0rem" font-weight="100" text-anchor="middle" transform="rotate(-90,209.528691,129.116074)">1870</text>
  <text x="119.558037" y="174.558037" font-size="1.0rem" font-weight="100" text-anchor="middle" transform="rotate(45,119.558037,174.558037)">1831</text>
</svg>
</td>
</tr>
</table></div></div></li><li class='xr-section-item'><input id='section-92f78b9b-4b46-4bec-a429-a1d37dce9c00' class='xr-section-summary-in' type='checkbox'  checked><label for='section-92f78b9b-4b46-4bec-a429-a1d37dce9c00' class='xr-section-summary' >Coordinates: <span>(4)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><ul class='xr-var-list'><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>variable</span></div><div class='xr-var-dims'>(variable)</div><div class='xr-var-dtype'>object</div><div class='xr-var-preview xr-preview'>&#x27;HRV&#x27; &#x27;IR_016&#x27; ... &#x27;WV_073&#x27;</div><input id='attrs-9ca9cdff-df2d-4de7-b7ce-0e60c97a1357' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-9ca9cdff-df2d-4de7-b7ce-0e60c97a1357' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-bd9c3f46-5bac-4980-9afd-0968dc06d9ed' class='xr-var-data-in' type='checkbox'><label for='data-bd9c3f46-5bac-4980-9afd-0968dc06d9ed' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([&#x27;HRV&#x27;, &#x27;IR_016&#x27;, &#x27;IR_039&#x27;, &#x27;IR_087&#x27;, &#x27;IR_097&#x27;, &#x27;IR_108&#x27;, &#x27;IR_120&#x27;,
       &#x27;IR_134&#x27;, &#x27;VIS006&#x27;, &#x27;VIS008&#x27;, &#x27;WV_062&#x27;, &#x27;WV_073&#x27;], dtype=object)</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>y</span></div><div class='xr-var-dims'>(y)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>9.012e+06 9.008e+06 ... 1.692e+06</div><input id='attrs-642378dd-9ed5-4b15-824f-1649fa0580e0' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-642378dd-9ed5-4b15-824f-1649fa0580e0' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-b3cce48a-7a98-4999-b71b-e5318d48185c' class='xr-var-data-in' type='checkbox'><label for='data-b3cce48a-7a98-4999-b71b-e5318d48185c' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([9012000., 9008000., 9004000., ..., 1700000., 1696000., 1692000.])</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>x</span></div><div class='xr-var-dims'>(x)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>-3.088e+06 -3.084e+06 ... 4.388e+06</div><input id='attrs-790df2a8-aa33-49db-8fb5-33b3427dc208' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-790df2a8-aa33-49db-8fb5-33b3427dc208' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-552a10b1-2b7b-4bd7-a124-4a3c53224fd3' class='xr-var-data-in' type='checkbox'><label for='data-552a10b1-2b7b-4bd7-a124-4a3c53224fd3' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([-3088000., -3084000., -3080000., ...,  4380000.,  4384000.,  4388000.])</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>time</span></div><div class='xr-var-dims'>(time)</div><div class='xr-var-dtype'>datetime64[ns]</div><div class='xr-var-preview xr-preview'>2021-03-19T13:20:10.330158</div><input id='attrs-b7dba93f-7518-49f6-b737-36898faf55e6' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-b7dba93f-7518-49f6-b737-36898faf55e6' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-c2f06ad8-306a-47df-8cd5-28200a6250b1' class='xr-var-data-in' type='checkbox'><label for='data-c2f06ad8-306a-47df-8cd5-28200a6250b1' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([&#x27;2021-03-19T13:20:10.330158000&#x27;], dtype=&#x27;datetime64[ns]&#x27;)</pre></div></li></ul></div></li><li class='xr-section-item'><input id='section-a0c666ed-6244-4f91-b7c2-6cb8ffc6dee2' class='xr-section-summary-in' type='checkbox'  checked><label for='section-a0c666ed-6244-4f91-b7c2-6cb8ffc6dee2' class='xr-section-summary' >Attributes: <span>(1)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><dl class='xr-attrs'><dt><span>meta :</span></dt><dd>{&#x27;orbital_parameters&#x27;: {&#x27;projection_longitude&#x27;: 9.5, &#x27;projection_latitude&#x27;: 0.0, &#x27;projection_altitude&#x27;: 35785831.0}, &#x27;sun_earth_distance_correction_applied&#x27;: True, &#x27;sun_earth_distance_correction_factor&#x27;: 0.9911189780118609, &#x27;units&#x27;: &#x27;%&#x27;, &#x27;wavelength&#x27;: WavelengthRange(min=0.5, central=0.7, max=0.9, unit=&#x27;Âµm&#x27;), &#x27;standard_name&#x27;: &#x27;toa_bidirectional_reflectance&#x27;, &#x27;platform_name&#x27;: &#x27;Meteosat-10&#x27;, &#x27;sensor&#x27;: &#x27;seviri&#x27;, &#x27;start_time&#x27;: datetime.datetime(2021, 3, 19, 13, 15, 9, 278906), &#x27;end_time&#x27;: datetime.datetime(2021, 3, 19, 13, 20, 10, 330158), &#x27;area&#x27;: Area ID: geos_seviri_hrv
Description: SEVIRI high resolution channel area
Projection ID: seviri_hrv
Projection: {&#x27;a&#x27;: &#x27;6378169&#x27;, &#x27;h&#x27;: &#x27;35785831&#x27;, &#x27;lon_0&#x27;: &#x27;9.5&#x27;, &#x27;no_defs&#x27;: &#x27;None&#x27;, &#x27;proj&#x27;: &#x27;geos&#x27;, &#x27;rf&#x27;: &#x27;295.488065897014&#x27;, &#x27;type&#x27;: &#x27;crs&#x27;, &#x27;units&#x27;: &#x27;m&#x27;, &#x27;x_0&#x27;: &#x27;0&#x27;, &#x27;y_0&#x27;: &#x27;0&#x27;}
Number of columns: 5568
Number of rows: 4176
Area extent: (2790874.9005, 5571248.3904, -2777873.154, 1394687.3495), &#x27;name&#x27;: &#x27;HRV&#x27;, &#x27;resolution&#x27;: 1000.134348869, &#x27;calibration&#x27;: &#x27;reflectance&#x27;, &#x27;modifiers&#x27;: (), &#x27;_satpy_id&#x27;: DataID(name=&#x27;HRV&#x27;, wavelength=WavelengthRange(min=0.5, central=0.7, max=0.9, unit=&#x27;Âµm&#x27;), resolution=1000.134348869, calibration=&lt;calibration.reflectance&gt;, modifiers=()), &#x27;ancillary_variables&#x27;: []}</dd></dl></div></li></ul></div></div>

<p><br></p>
<p>Now we can save it!</p>
<div class="highlight"><pre><span></span><code><span class="n">save_data</span> <span class="o">=</span> <span class="kc">False</span>

<span class="k">if</span> <span class="n">save_data</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">out_zarr_bucket</span> <span class="o">=</span> <span class="s1">&#39;solar-pv-nowcasting-data/satellite/EUMETSAT/SEVIRI_RSS/zarr_full_extent_TM_int16&#39;</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">save_da_to_zarr</span><span class="p">(</span><span class="n">da_compressed</span><span class="p">,</span> <span class="n">out_zarr_bucket</span><span class="p">,</span> <span class="n">zarr_mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>/Users/laurence/conda/envs/satip_dev/lib/python3.8/site-packages/dask/core.py:121: RuntimeWarning: divide by zero encountered in true_divide
  return func(*(_execute_task(a, cache) for a in args))
/Users/laurence/conda/envs/satip_dev/lib/python3.8/site-packages/dask/core.py:121: RuntimeWarning: invalid value encountered in sin
  return func(*(_execute_task(a, cache) for a in args))
/Users/laurence/conda/envs/satip_dev/lib/python3.8/site-packages/dask/core.py:121: RuntimeWarning: invalid value encountered in cos
  return func(*(_execute_task(a, cache) for a in args))


Saved file to zarr bucket
</code></pre></div>
<p><br></p>
<h3 id="loading-zarr-data">Loading Zarr Data<a class="headerlink" href="#loading-zarr-data" title="Permanent link">&para;</a></h3>
<p>We'll start by defining a loading function and a replacement for the standard <code>gcsfs.utils</code> <code>is_retriable</code> function</p>
<div class="highlight"><pre><span></span><code><span class="c1">#exports</span>
<span class="k">def</span> <span class="nf">is_retriable</span><span class="p">(</span><span class="n">exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns True if this exception is retriable.&quot;&quot;&quot;</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="mi">505</span><span class="p">))</span> <span class="o">+</span> <span class="p">[</span>
        <span class="mi">400</span><span class="p">,</span> <span class="c1"># Jack&#39;s addition.  Google Cloud occasionally throws Bad Requests for no apparent reason.</span>
        <span class="mi">408</span><span class="p">,</span><span class="c1"># Request Timeout</span>
        <span class="mi">429</span><span class="p">,</span> <span class="c1"># Too Many Requests</span>
    <span class="p">]</span>

    <span class="n">errors</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">errors</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exception</span><span class="p">,</span> <span class="n">gcsfs</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">HttpError</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">exception</span><span class="o">.</span><span class="n">code</span> <span class="ow">in</span> <span class="n">errors</span>

    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exception</span><span class="p">,</span> <span class="n">gcsfs</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">RETRIABLE_EXCEPTIONS</span><span class="p">)</span>

<span class="n">gcsfs</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">is_retriable</span> <span class="o">=</span> <span class="n">is_retriable</span>

<span class="n">get_unix_as_time</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">da</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">da</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">load_from_zarr_bucket</span><span class="p">(</span><span class="n">zarr_bucket</span><span class="p">):</span>
    <span class="n">gcs</span> <span class="o">=</span> <span class="n">gcsfs</span><span class="o">.</span><span class="n">GCSFileSystem</span><span class="p">()</span>
    <span class="n">store</span> <span class="o">=</span> <span class="n">gcsfs</span><span class="o">.</span><span class="n">GCSMap</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="n">zarr_bucket</span><span class="p">,</span> <span class="n">gcs</span><span class="o">=</span><span class="n">gcs</span><span class="p">)</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_zarr</span><span class="p">(</span><span class="n">store</span><span class="p">,</span> <span class="n">consolidated</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_unix_as_time</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ds</span>
</code></pre></div>
<p><br></p>
<p>We'll now read it in</p>
<div class="highlight"><pre><span></span><code><span class="o">%%</span><span class="n">time</span>

<span class="n">out_zarr_bucket</span> <span class="o">=</span> <span class="s1">&#39;solar-pv-nowcasting-data/satellite/EUMETSAT/SEVIRI_RSS/zarr_full_extent_TM_int16&#39;</span>

<span class="n">ds_zarr</span> <span class="o">=</span> <span class="n">load_from_zarr_bucket</span><span class="p">(</span><span class="n">out_zarr_bucket</span><span class="p">)</span>

<span class="n">ds_zarr</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>CPU times: user 4.14 s, sys: 1.7 s, total: 5.84 s
Wall time: 21.3 s
</code></pre></div>
<div><svg style="position: absolute; width: 0; height: 0; overflow: hidden">
<defs>
<symbol id="icon-database" viewBox="0 0 32 32">
<path d="M16 0c-8.837 0-16 2.239-16 5v4c0 2.761 7.163 5 16 5s16-2.239 16-5v-4c0-2.761-7.163-5-16-5z"></path>
<path d="M16 17c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
<path d="M16 26c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
</symbol>
<symbol id="icon-file-text2" viewBox="0 0 32 32">
<path d="M28.681 7.159c-0.694-0.947-1.662-2.053-2.724-3.116s-2.169-2.030-3.116-2.724c-1.612-1.182-2.393-1.319-2.841-1.319h-15.5c-1.378 0-2.5 1.121-2.5 2.5v27c0 1.378 1.122 2.5 2.5 2.5h23c1.378 0 2.5-1.122 2.5-2.5v-19.5c0-0.448-0.137-1.23-1.319-2.841zM24.543 5.457c0.959 0.959 1.712 1.825 2.268 2.543h-4.811v-4.811c0.718 0.556 1.584 1.309 2.543 2.268zM28 29.5c0 0.271-0.229 0.5-0.5 0.5h-23c-0.271 0-0.5-0.229-0.5-0.5v-27c0-0.271 0.229-0.5 0.5-0.5 0 0 15.499-0 15.5 0v7c0 0.552 0.448 1 1 1h7v19.5z"></path>
<path d="M23 26h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 22h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 18h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
</symbol>
</defs>
</svg>
<style>/* CSS stylesheet for displaying xarray objects in jupyterlab.
 *
 */

:root {
  --xr-font-color0: var(--jp-content-font-color0, rgba(0, 0, 0, 1));
  --xr-font-color2: var(--jp-content-font-color2, rgba(0, 0, 0, 0.54));
  --xr-font-color3: var(--jp-content-font-color3, rgba(0, 0, 0, 0.38));
  --xr-border-color: var(--jp-border-color2, #e0e0e0);
  --xr-disabled-color: var(--jp-layout-color3, #bdbdbd);
  --xr-background-color: var(--jp-layout-color0, white);
  --xr-background-color-row-even: var(--jp-layout-color1, white);
  --xr-background-color-row-odd: var(--jp-layout-color2, #eeeeee);
}

html[theme=dark],
body.vscode-dark {
  --xr-font-color0: rgba(255, 255, 255, 1);
  --xr-font-color2: rgba(255, 255, 255, 0.54);
  --xr-font-color3: rgba(255, 255, 255, 0.38);
  --xr-border-color: #1F1F1F;
  --xr-disabled-color: #515151;
  --xr-background-color: #111111;
  --xr-background-color-row-even: #111111;
  --xr-background-color-row-odd: #313131;
}

.xr-wrap {
  display: block;
  min-width: 300px;
  max-width: 700px;
}

.xr-text-repr-fallback {
  /* fallback to plain text repr when CSS is not injected (untrusted notebook) */
  display: none;
}

.xr-header {
  padding-top: 6px;
  padding-bottom: 6px;
  margin-bottom: 4px;
  border-bottom: solid 1px var(--xr-border-color);
}

.xr-header > div,
.xr-header > ul {
  display: inline;
  margin-top: 0;
  margin-bottom: 0;
}

.xr-obj-type,
.xr-array-name {
  margin-left: 2px;
  margin-right: 10px;
}

.xr-obj-type {
  color: var(--xr-font-color2);
}

.xr-sections {
  padding-left: 0 !important;
  display: grid;
  grid-template-columns: 150px auto auto 1fr 20px 20px;
}

.xr-section-item {
  display: contents;
}

.xr-section-item input {
  display: none;
}

.xr-section-item input + label {
  color: var(--xr-disabled-color);
}

.xr-section-item input:enabled + label {
  cursor: pointer;
  color: var(--xr-font-color2);
}

.xr-section-item input:enabled + label:hover {
  color: var(--xr-font-color0);
}

.xr-section-summary {
  grid-column: 1;
  color: var(--xr-font-color2);
  font-weight: 500;
}

.xr-section-summary > span {
  display: inline-block;
  padding-left: 0.5em;
}

.xr-section-summary-in:disabled + label {
  color: var(--xr-font-color2);
}

.xr-section-summary-in + label:before {
  display: inline-block;
  content: 'â–º';
  font-size: 11px;
  width: 15px;
  text-align: center;
}

.xr-section-summary-in:disabled + label:before {
  color: var(--xr-disabled-color);
}

.xr-section-summary-in:checked + label:before {
  content: 'â–¼';
}

.xr-section-summary-in:checked + label > span {
  display: none;
}

.xr-section-summary,
.xr-section-inline-details {
  padding-top: 4px;
  padding-bottom: 4px;
}

.xr-section-inline-details {
  grid-column: 2 / -1;
}

.xr-section-details {
  display: none;
  grid-column: 1 / -1;
  margin-bottom: 5px;
}

.xr-section-summary-in:checked ~ .xr-section-details {
  display: contents;
}

.xr-array-wrap {
  grid-column: 1 / -1;
  display: grid;
  grid-template-columns: 20px auto;
}

.xr-array-wrap > label {
  grid-column: 1;
  vertical-align: top;
}

.xr-preview {
  color: var(--xr-font-color3);
}

.xr-array-preview,
.xr-array-data {
  padding: 0 5px !important;
  grid-column: 2;
}

.xr-array-data,
.xr-array-in:checked ~ .xr-array-preview {
  display: none;
}

.xr-array-in:checked ~ .xr-array-data,
.xr-array-preview {
  display: inline-block;
}

.xr-dim-list {
  display: inline-block !important;
  list-style: none;
  padding: 0 !important;
  margin: 0;
}

.xr-dim-list li {
  display: inline-block;
  padding: 0;
  margin: 0;
}

.xr-dim-list:before {
  content: '(';
}

.xr-dim-list:after {
  content: ')';
}

.xr-dim-list li:not(:last-child):after {
  content: ',';
  padding-right: 5px;
}

.xr-has-index {
  font-weight: bold;
}

.xr-var-list,
.xr-var-item {
  display: contents;
}

.xr-var-item > div,
.xr-var-item label,
.xr-var-item > .xr-var-name span {
  background-color: var(--xr-background-color-row-even);
  margin-bottom: 0;
}

.xr-var-item > .xr-var-name:hover span {
  padding-right: 5px;
}

.xr-var-list > li:nth-child(odd) > div,
.xr-var-list > li:nth-child(odd) > label,
.xr-var-list > li:nth-child(odd) > .xr-var-name span {
  background-color: var(--xr-background-color-row-odd);
}

.xr-var-name {
  grid-column: 1;
}

.xr-var-dims {
  grid-column: 2;
}

.xr-var-dtype {
  grid-column: 3;
  text-align: right;
  color: var(--xr-font-color2);
}

.xr-var-preview {
  grid-column: 4;
}

.xr-var-name,
.xr-var-dims,
.xr-var-dtype,
.xr-preview,
.xr-attrs dt {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  padding-right: 10px;
}

.xr-var-name:hover,
.xr-var-dims:hover,
.xr-var-dtype:hover,
.xr-attrs dt:hover {
  overflow: visible;
  width: auto;
  z-index: 1;
}

.xr-var-attrs,
.xr-var-data {
  display: none;
  background-color: var(--xr-background-color) !important;
  padding-bottom: 5px !important;
}

.xr-var-attrs-in:checked ~ .xr-var-attrs,
.xr-var-data-in:checked ~ .xr-var-data {
  display: block;
}

.xr-var-data > table {
  float: right;
}

.xr-var-name span,
.xr-var-data,
.xr-attrs {
  padding-left: 25px !important;
}

.xr-attrs,
.xr-var-attrs,
.xr-var-data {
  grid-column: 1 / -1;
}

dl.xr-attrs {
  padding: 0;
  margin: 0;
  display: grid;
  grid-template-columns: 125px auto;
}

.xr-attrs dt,
.xr-attrs dd {
  padding: 0;
  margin: 0;
  float: left;
  padding-right: 10px;
  width: auto;
}

.xr-attrs dt {
  font-weight: normal;
  grid-column: 1;
}

.xr-attrs dt:hover span {
  display: inline-block;
  background: var(--xr-background-color);
  padding-right: 10px;
}

.xr-attrs dd {
  grid-column: 2;
  white-space: pre-wrap;
  word-break: break-all;
}

.xr-icon-database,
.xr-icon-file-text2 {
  display: inline-block;
  vertical-align: middle;
  width: 1em;
  height: 1.5em !important;
  stroke-width: 0;
  stroke: currentColor;
  fill: currentColor;
}
</style><pre class='xr-text-repr-fallback'>&lt;xarray.DataArray &#x27;time&#x27; (time: 5816)&gt;
array([&#x27;2021-03-19T13:20:10.000000000&#x27;, &#x27;2021-03-19T13:24:16.000000000&#x27;,
       &#x27;2021-03-19T13:29:17.000000000&#x27;, ..., &#x27;2020-03-14T23:49:18.000000000&#x27;,
       &#x27;2020-03-14T23:54:17.000000000&#x27;, &#x27;2020-03-14T23:59:15.000000000&#x27;],
      dtype=&#x27;datetime64[ns]&#x27;)
Coordinates:
  * time     (time) datetime64[ns] 2021-03-19T13:20:10 ... 2020-03-14T23:59:15</pre><div class='xr-wrap' hidden><div class='xr-header'><div class='xr-obj-type'>xarray.DataArray</div><div class='xr-array-name'>'time'</div><ul class='xr-dim-list'><li><span class='xr-has-index'>time</span>: 5816</li></ul></div><ul class='xr-sections'><li class='xr-section-item'><div class='xr-array-wrap'><input id='section-1f06b848-4cff-4ad8-92f7-6b93d8d0b477' class='xr-array-in' type='checkbox' checked><label for='section-1f06b848-4cff-4ad8-92f7-6b93d8d0b477' title='Show/hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-array-preview xr-preview'><span>2021-03-19T13:20:10 2021-03-19T13:24:16 ... 2020-03-14T23:59:15</span></div><div class='xr-array-data'><pre>array([&#x27;2021-03-19T13:20:10.000000000&#x27;, &#x27;2021-03-19T13:24:16.000000000&#x27;,
       &#x27;2021-03-19T13:29:17.000000000&#x27;, ..., &#x27;2020-03-14T23:49:18.000000000&#x27;,
       &#x27;2020-03-14T23:54:17.000000000&#x27;, &#x27;2020-03-14T23:59:15.000000000&#x27;],
      dtype=&#x27;datetime64[ns]&#x27;)</pre></div></div></li><li class='xr-section-item'><input id='section-18c7b3b9-ef8f-45da-8683-f146da27ba4d' class='xr-section-summary-in' type='checkbox'  checked><label for='section-18c7b3b9-ef8f-45da-8683-f146da27ba4d' class='xr-section-summary' >Coordinates: <span>(1)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><ul class='xr-var-list'><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>time</span></div><div class='xr-var-dims'>(time)</div><div class='xr-var-dtype'>datetime64[ns]</div><div class='xr-var-preview xr-preview'>2021-03-19T13:20:10 ... 2020-03-...</div><input id='attrs-93e4561d-e083-4a6e-9dda-d4a445c771a9' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-93e4561d-e083-4a6e-9dda-d4a445c771a9' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-bedb239d-e4d0-48bc-a042-22bfaa25911a' class='xr-var-data-in' type='checkbox'><label for='data-bedb239d-e4d0-48bc-a042-22bfaa25911a' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([&#x27;2021-03-19T13:20:10.000000000&#x27;, &#x27;2021-03-19T13:24:16.000000000&#x27;,
       &#x27;2021-03-19T13:29:17.000000000&#x27;, ..., &#x27;2020-03-14T23:49:18.000000000&#x27;,
       &#x27;2020-03-14T23:54:17.000000000&#x27;, &#x27;2020-03-14T23:59:15.000000000&#x27;],
      dtype=&#x27;datetime64[ns]&#x27;)</pre></div></li></ul></div></li><li class='xr-section-item'><input id='section-1d5348a9-8c20-4476-8b24-22fde4674305' class='xr-section-summary-in' type='checkbox' disabled ><label for='section-1d5348a9-8c20-4476-8b24-22fde4674305' class='xr-section-summary'  title='Expand/collapse section'>Attributes: <span>(0)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><dl class='xr-attrs'></dl></div></li></ul></div></div>

<p><br></p>
<p>Let's inspect the current datetime coverage in the database</p>
<div class="highlight"><pre><span></span><code><span class="c1">#exports</span>
<span class="k">def</span> <span class="nf">plot_zarr_data</span><span class="p">(</span><span class="n">loaded_xarray</span><span class="p">):</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">loaded_xarray</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;D&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="c1"># rather than messing with formatter, set index to a readable date format of Year-Month</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m&#39;</span><span class="p">)))</span>

    <span class="c1"># plot</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">xticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Count of timesteps by day in Zarr datastore&quot;</span><span class="p">)</span>

    <span class="c1"># reduce tick counts</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">locator_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">nbins</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">plot_zarr_data</span><span class="p">(</span><span class="n">loaded_xarray</span><span class="p">)</span>
</code></pre></div>
<p><img alt="png" src="../img/nbs/output_32_0.png" /></p>
<p><br></p>
<p>We'll also plot the a sample of the loaded array</p>
<div class="highlight"><pre><span></span><code><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">TransverseMercator</span><span class="p">())</span>

<span class="n">loaded_xarray</span><span class="p">[</span><span class="s1">&#39;stacked_eumetsat_data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">variable</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;magma&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">200</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">coastlines</span><span class="p">(</span><span class="n">resolution</span><span class="o">=</span><span class="s1">&#39;50m&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>&lt;ipython-input-26-f7e189d5f897&gt;:2: UserWarning: The default value for the *approx* keyword argument to TransverseMercator will change from True to False after 0.18.
  ax = plt.axes(projection=ccrs.TransverseMercator())





&lt;cartopy.mpl.feature_artist.FeatureArtist at 0x7fc2df31c0a0&gt;
</code></pre></div>
<p><img alt="png" src="../img/nbs/output_34_2.png" /></p>
<p><br></p>
<p>We can also identify missing datasets which will be useful for filling them in later</p>
<div class="highlight"><pre><span></span><code><span class="c1">#exports</span>
<span class="k">def</span> <span class="nf">identifying_missing_datasets</span><span class="p">(</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">,</span> <span class="n">eumetsat_zarr_bucket</span><span class="o">=</span><span class="s1">&#39;solar-pv-nowcasting-data/satellite/EUMETSAT/SEVIRI_RSS/zarr_full_extent_TM_int16&#39;</span><span class="p">):</span>
    <span class="c1"># constructing the monthly split</span>
    <span class="n">month_split</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s2">&quot;MS&quot;</span><span class="p">)</span>

    <span class="c1"># handling date range less than a month</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">month_split</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">month_split</span> <span class="o">=</span> <span class="p">[</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">]</span>

    <span class="c1"># identifying missing datasets in each split</span>
    <span class="n">missing_datasets</span> <span class="o">=</span> <span class="p">[]</span> 
    <span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Earliest </span><span class="si">{</span><span class="n">start_date</span><span class="si">}</span><span class="s1">, latest </span><span class="si">{</span><span class="n">end_date</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">month_split</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="c1"># Identifying all potential datasets over specified date range</span>
        <span class="n">datasets</span> <span class="o">=</span> <span class="n">eumetsat</span><span class="o">.</span><span class="n">identify_available_datasets</span><span class="p">(</span><span class="n">month_split</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">month_split</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># Extracting the datetime each dataset was finished</span>
        <span class="n">end_dates</span> <span class="o">=</span> <span class="p">[</span><span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">][</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cleaned_end_dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">end_dates</span><span class="p">)</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="s1">&#39;UTC&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">tz_convert</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">cleaned_end_dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">end_dates</span><span class="p">)</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">tz_convert</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Identifying missing datasets from the Zarr DB</span>
        <span class="n">ds_eumetsat</span> <span class="o">=</span> <span class="n">load_from_zarr_bucket</span><span class="p">(</span><span class="n">eumetsat_zarr_bucket</span><span class="p">)</span>
        <span class="n">end_dates_to_datasets</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">cleaned_end_dates</span><span class="p">,</span> <span class="n">datasets</span><span class="p">))</span>
        <span class="n">missing_dates</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">cleaned_end_dates</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">ds_eumetsat</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="n">missing_datasets</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">data</span> <span class="k">for</span> <span class="n">date</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">end_dates_to_datasets</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">missing_dates</span><span class="p">])</span>

    <span class="n">flat_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">missing_datasets</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">flat_list</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">missing_datasets</span> <span class="o">=</span> <span class="n">identifying_missing_datasets</span><span class="p">(</span><span class="s2">&quot;2020-01-01T00:00:00&quot;</span><span class="p">,</span> <span class="s2">&quot;2020-01-01T01:00:00&quot;</span><span class="p">)</span>

<span class="n">JSON</span><span class="p">(</span><span class="n">missing_datasets</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>Earliest 2020-01-01T00:00:00, latest 2020-01-01T01:00:00
</code></pre></div>
<div><span class="Text-label" style="display:inline-block; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; min-width:0; max-width:15ex; vertical-align:middle; text-align:right"></span>
<progress style="width:60ex" max="1" value="1" class="Progress-main"/></progress>
<span class="Progress-label"><strong>100%</strong></span>
<span class="Iteration-label">1/1</span>
<span class="Time-label">[00:04<00:04, 3.91s/it]</span></div>

<div class="highlight"><pre><span></span><code>identify_available_datasets: found 12 results from API





&lt;IPython.core.display.JSON object&gt;
</code></pre></div>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../02_reproj/" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Reprojection
              </div>
            </div>
          </a>
        
        
          <a href="../04_gcp/" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                GCP Analytics
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/vendor.93c04032.min.js"></script>
      <script src="../assets/javascripts/bundle.83e5331e.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}</script>
      
      <script>
        app = initialize({
          base: "..",
          features: ['header.autohide', 'navigation.tabs', 'navigation.instant', 'search.suggest'],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.8c7e0a7e.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
        <script src="../javascripts/config.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>