
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-6.1.7">
    
    
      
        <title>Downloading - Satip Documentation</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.19753c6b.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.196e0c26.min.css">
        
          
          
          <meta name="theme-color" content="#000000">
        
      
    
    
    
      
        
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="black" data-md-color-accent="">
      
  
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#eumetsat-api-wrapper-development" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href=".." title="Satip Documentation" class="md-header-nav__button md-logo" aria-label="Satip Documentation">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            Satip Documentation
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Downloading
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/Future-Energy-Associates/satip/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    Future-Energy-Associates/satip
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          

  

<nav class="md-tabs md-tabs--active" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  <li class="md-tabs__item">
    
    
    <a href=".." class="md-tabs__link">
      Home
    </a>
  </li>

      
        
  
  
    <li class="md-tabs__item">
      
      
      <a href="../101_downloading/" class="md-tabs__link">
        User Guide
      </a>
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
      
      <a href="../about/OCF/" class="md-tabs__link">
        About
      </a>
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
      
        
      
      <a href="../00_utils/" class="md-tabs__link md-tabs__link--active">
        Development
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Satip Documentation" class="md-nav__button md-logo" aria-label="Satip Documentation">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Satip Documentation
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/Future-Energy-Associates/satip/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    Future-Energy-Associates/satip
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2" >
    <label class="md-nav__link" for="nav-2">
      User Guide
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="User Guide" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        <span class="md-nav__icon md-icon"></span>
        User Guide
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../101_downloading/" class="md-nav__link">
      Downloading from EUMETSAT
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../102_reprojecting/" class="md-nav__link">
      Reprojecting
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../103_loading/" class="md-nav__link">
      Loading from Zarr
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" >
    <label class="md-nav__link" for="nav-3">
      About
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="About" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        <span class="md-nav__icon md-icon"></span>
        About
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../about/OCF/" class="md-nav__link">
      OCF
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4" checked>
    <label class="md-nav__link" for="nav-4">
      Development
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Development" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        <span class="md-nav__icon md-icon"></span>
        Development
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../00_utils/" class="md-nav__link">
      Utilities
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Downloading
        <span class="md-nav__icon md-icon"></span>
      </label>
    
    <a href="./" class="md-nav__link md-nav__link--active">
      Downloading
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#user-input" class="md-nav__link">
    User Input
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#authorising-api-access" class="md-nav__link">
    Authorising API Access
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#querying-available-data" class="md-nav__link">
    Querying Available Data
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#downloading-data" class="md-nav__link">
    Downloading Data
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#integration-with-google-cloud-storage" class="md-nav__link">
    Integration with Google Cloud Storage
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#name-convention-changes-in-eumetsat-files" class="md-nav__link">
    Name Convention changes in EUMETSAT files
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#helper-utils" class="md-nav__link">
    Helper utils
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#compress-downloaded-native-image-files" class="md-nav__link">
    Compress downloaded native image files
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#syncing-files-to-gcp-storage" class="md-nav__link">
    Syncing files to GCP Storage
  </a>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../02_reproj/" class="md-nav__link">
      Reprojection
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../03_zarr/" class="md-nav__link">
      Saving with Zarr
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../04_gcp/" class="md-nav__link">
      GCP Analytics
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../05_pipeline/" class="md-nav__link">
      Pipelines
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#user-input" class="md-nav__link">
    User Input
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#authorising-api-access" class="md-nav__link">
    Authorising API Access
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#querying-available-data" class="md-nav__link">
    Querying Available Data
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#downloading-data" class="md-nav__link">
    Downloading Data
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#integration-with-google-cloud-storage" class="md-nav__link">
    Integration with Google Cloud Storage
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#name-convention-changes-in-eumetsat-files" class="md-nav__link">
    Name Convention changes in EUMETSAT files
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#helper-utils" class="md-nav__link">
    Helper utils
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#compress-downloaded-native-image-files" class="md-nav__link">
    Compress downloaded native image files
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#syncing-files-to-gcp-storage" class="md-nav__link">
    Syncing files to GCP Storage
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/Future-Energy-Associates/satip/edit/master/docs/01_eumetsat.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="eumetsat-api-wrapper-development">EUMETSAT API Wrapper Development<a class="headerlink" href="#eumetsat-api-wrapper-development" title="Permanent link">&para;</a></h1>
<p><br></p>
<h3 id="user-input">User Input<a class="headerlink" href="#user-input" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">data_dir</span> <span class="o">=</span> <span class="s1">&#39;../data/raw&#39;</span>
<span class="n">compressed_dir</span> <span class="o">=</span> <span class="s1">&#39;../data/compressed&#39;</span>
<span class="n">debug_fp</span> <span class="o">=</span> <span class="s1">&#39;../logs/EUMETSAT_download.txt&#39;</span>
<span class="n">env_vars_fp</span> <span class="o">=</span> <span class="s1">&#39;../.env&#39;</span>
<span class="n">metadata_db_fp</span> <span class="o">=</span> <span class="s1">&#39;../data/EUMETSAT_metadata.db&#39;</span>

<span class="n">download_data</span> <span class="o">=</span> <span class="kc">True</span>
</code></pre></div>
<p><br></p>
<h3 id="authorising-api-access">Authorising API Access<a class="headerlink" href="#authorising-api-access" title="Permanent link">&para;</a></h3>
<p>First we'll load the the environment variables</p>
<div class="highlight"><pre><span></span><code><span class="n">dotenv</span><span class="o">.</span><span class="n">load_dotenv</span><span class="p">(</span><span class="n">env_vars_fp</span><span class="p">)</span>

<span class="n">user_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;USER_KEY&#39;</span><span class="p">)</span>
<span class="n">user_secret</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;USER_SECRET&#39;</span><span class="p">)</span>
<span class="n">slack_id</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SLACK_ID&#39;</span><span class="p">)</span>
<span class="n">slack_webhook_url</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SLACK_WEBHOOK_URL&#39;</span><span class="p">)</span>
</code></pre></div>
<p><br></p>
<p>And test they were loaded successfully</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">check_env_vars_have_loaded</span><span class="p">(</span><span class="n">env_vars</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">env_vars</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">assert</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">` should not be None&#39;</span>

    <span class="k">return</span>

<span class="n">env_vars</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;user_key&#39;</span><span class="p">:</span> <span class="n">user_key</span><span class="p">,</span>
    <span class="s1">&#39;user_secret&#39;</span><span class="p">:</span> <span class="n">user_secret</span><span class="p">,</span>
    <span class="s1">&#39;slack_id&#39;</span><span class="p">:</span> <span class="n">slack_id</span><span class="p">,</span>
    <span class="s1">&#39;slack_webhook_url&#39;</span><span class="p">:</span> <span class="n">slack_webhook_url</span>
<span class="p">}</span>

<span class="n">check_env_vars_have_loaded</span><span class="p">(</span><span class="n">env_vars</span><span class="p">)</span>
</code></pre></div>
<p><br></p>
<p>We'll then use them to request an access token for the API</p>
<p><br></p>
<p>We'll then use them to request an access token for the API</p>
<div class="highlight"><pre><span></span><code><span class="n">access_token</span> <span class="o">=</span> <span class="n">request_access_token</span><span class="p">(</span><span class="n">user_key</span><span class="p">,</span> <span class="n">user_secret</span><span class="p">)</span>
</code></pre></div>
<p><br></p>
<h3 id="querying-available-data">Querying Available Data<a class="headerlink" href="#querying-available-data" title="Permanent link">&para;</a></h3>
<p>Before we can download any data we have to know where it's stored. To learn this we can query their search-products API, which returns a JSON containing a list of file metadata.</p>
<p><br></p>
<p>We'll quickly make a test request to this end-point</p>
<div class="highlight"><pre><span></span><code><span class="n">start_date</span> <span class="o">=</span> <span class="s1">&#39;2019-10-01&#39;</span>
<span class="n">end_date</span> <span class="o">=</span> <span class="s1">&#39;2019-10-07&#39;</span>

<span class="n">r</span> <span class="o">=</span> <span class="n">query_data_products</span><span class="p">(</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">)</span>

<span class="n">r_json</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
<span class="n">JSON</span><span class="p">(</span><span class="n">r_json</span><span class="p">)</span>
</code></pre></div>
<p><br></p>
<p>However the search-api is capped (at 10,000) for the number of files it will return metadata for, so we'll create a while loop that waits until all the relevant data has been returned. We'll then extract just the list of features from the returned JSONs.</p>
<p><br></p>
<p>We'll check that the same number of available datasets are identified</p>
<div class="highlight"><pre><span></span><code><span class="o">%%</span><span class="n">time</span>

<span class="n">datasets</span> <span class="o">=</span> <span class="n">identify_available_datasets</span><span class="p">(</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">datasets</span><span class="p">)</span><span class="si">}</span><span class="s1"> datasets have been identified&#39;</span><span class="p">)</span>
</code></pre></div>
<p><br></p>
<p>Finally we'll create a helper function for converting the dataset ids into their file urls.</p>
<p><br></p>
<p>We'll now test this works.</p>
<p>N.b. You cannot use the link returned here directly as it will not be OAuth'ed</p>
<div class="highlight"><pre><span></span><code><span class="n">dataset_ids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">])</span>
<span class="n">example_data_link</span> <span class="o">=</span> <span class="n">dataset_id_to_link</span><span class="p">(</span><span class="n">dataset_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="n">example_data_link</span>
</code></pre></div>
<p><br></p>
<h3 id="downloading-data">Downloading Data<a class="headerlink" href="#downloading-data" title="Permanent link">&para;</a></h3>
<p>Now that we know where our data is located we want to download it. First we'll check that the directory we wish to save the data in exists, if not we'll create it</p>
<div class="highlight"><pre><span></span><code><span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="p">[</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">sorted_dir</span><span class="p">]:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
</code></pre></div>
<p><br></p>
<p>We also want to extract the relevant metadata information from each file. Here we'll create a generalised framework for extracting data from any product, to add a new one please add its metadata mapping under the relevant <code>product_id</code>.</p>
<p><br></p>
<p>We're now ready to create a download manager that will handle all of the querying, processing and retrieving for us</p>
<p><br></p>
<p>We'll now see what it looks like when we initialise the download manager</p>
<div class="highlight"><pre><span></span><code><span class="n">dm</span> <span class="o">=</span> <span class="n">DownloadManager</span><span class="p">(</span><span class="n">user_key</span><span class="p">,</span> <span class="n">user_secret</span><span class="p">,</span> <span class="n">data_dir</span><span class="p">,</span> <span class="n">metadata_db_fp</span><span class="p">,</span> <span class="n">debug_fp</span><span class="p">,</span> 
                     <span class="n">slack_webhook_url</span><span class="o">=</span><span class="n">slack_webhook_url</span><span class="p">,</span> <span class="n">slack_id</span><span class="o">=</span><span class="n">slack_id</span><span class="p">)</span>

<span class="n">start_date</span> <span class="o">=</span> <span class="s1">&#39;2020-10-01 12:00&#39;</span>
<span class="n">end_date</span> <span class="o">=</span> <span class="s1">&#39;2020-10-01 12:05&#39;</span>

<span class="k">if</span> <span class="n">download_data</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">dm</span><span class="o">.</span><span class="n">download_date_range</span><span class="p">(</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">)</span>

<span class="n">df_metadata</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">get_df_metadata</span><span class="p">()</span>

<span class="n">df_metadata</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</code></pre></div>
<p><br></p>
<p>The <code>get_size</code> function was adapted from <a href="https://stackoverflow.com/questions/1392413/calculating-a-directorys-size-using-python">this stackoverflow answer</a></p>
<div class="highlight"><pre><span></span><code><span class="n">data_dir_size</span> <span class="o">=</span> <span class="n">get_dir_size</span><span class="p">(</span><span class="n">data_dir</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The data directory is currently </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">data_dir_size</span><span class="o">/</span><span class="mi">1_000_000_000</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="si">:</span><span class="s1">,</span><span class="si">}</span><span class="s1"> Gb&#39;</span><span class="p">)</span>
</code></pre></div>
<h2 id="integration-with-google-cloud-storage">Integration with Google Cloud Storage<a class="headerlink" href="#integration-with-google-cloud-storage" title="Permanent link">&para;</a></h2>
<p>If Google Cloud Platform (GCP) flags are passed (<code>bucket_name</code> and <code>bucket_prefix</code>), when downloading, then the <code>DownloadManager</code> should first check to see if the files already exist in the specified cloud storage bucket.<br />
If the files already exist, then they will not be downloaded locally - if the storage bucket arguments are passed.  </p>
<div class="highlight"><pre><span></span><code><span class="n">BUCKET_NAME</span> <span class="o">=</span> <span class="s2">&quot;solar-pv-nowcasting-data&quot;</span>
<span class="n">PREFIX</span> <span class="o">=</span> <span class="s2">&quot;satellite/EUMETSAT/SEVIRI_RSS/native/2020&quot;</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">dm</span> <span class="o">=</span> <span class="n">DownloadManager</span><span class="p">(</span><span class="n">user_key</span><span class="p">,</span> <span class="n">user_secret</span><span class="p">,</span> <span class="n">data_dir</span><span class="p">,</span> <span class="n">metadata_db_fp</span><span class="p">,</span> <span class="n">debug_fp</span><span class="p">,</span> <span class="n">bucket_name</span><span class="o">=</span><span class="n">BUCKET_NAME</span><span class="p">,</span> <span class="n">bucket_prefix</span><span class="o">=</span><span class="n">PREFIX</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># Bucket filenames can be accessed</span>
<span class="nb">len</span><span class="p">(</span><span class="n">dm</span><span class="o">.</span><span class="n">bucket_filenames</span><span class="p">)</span>
</code></pre></div>
<p>Lets test this by examining some dates at the start of 2020</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Timings: around 2 hours to download 1 day.</span>

<span class="c1"># DownloadManager should find these 2020 files on the VM</span>
<span class="n">start_date</span> <span class="o">=</span> <span class="s1">&#39;2020-01-01 00:00&#39;</span>
<span class="n">end_date</span> <span class="o">=</span> <span class="s1">&#39;2020-01-02 00:00&#39;</span>
<span class="n">dm</span><span class="o">.</span><span class="n">download_date_range</span><span class="p">(</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">)</span>
</code></pre></div>
<h2 id="name-convention-changes-in-eumetsat-files">Name Convention changes in EUMETSAT files<a class="headerlink" href="#name-convention-changes-in-eumetsat-files" title="Permanent link">&para;</a></h2>
<p>Probably due to the changes / creation of the EUMETSAT API around the end of 2019, newer files do not contain the previous 'order number' parts at the end of the filename. </p>
<p>Some previously downloaded files follow a different file name convention:</p>
<p>Files through new API:
<code>MSG3-SEVI-MSG15-0100-NA-20191001120415.883000000Z-NA.nat</code><br />
SatProgram-Instrument-SatNumber-AlgoVersion-InstrumentMode(?)-ReceptionStartDateUTC   </p>
<p>Files on GCP:<br />
<code>MSG3-SEVI-MSG15-0100-NA-20191001120415.883000000Z-20191001120433-1399526-1.nat.bz2</code><br />
SatProgram-Instrument-SatNumber-AlgoVersion-InstrumentMode(?)-ReceptionStartDateUTC-SensingStartDateUTC-OrderNumber-PartNumber </p>
<p>We can use regex to take the first part of the filename for comparisons</p>
<div class="highlight"><pre><span></span><code><span class="n">txt</span> <span class="o">=</span> <span class="s2">&quot;MSG3-SEVI-MSG15-0100-NA-20190101000417.314000000Z-20190101000435-1377854-1.nat&quot;</span>
<span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;([A-Z\d.]+-)</span><span class="si">{6}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">txt</span><span class="p">)[</span><span class="mi">0</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># [:-1] to trim the trailing -</span>
</code></pre></div>
<p>To ensure we are comparing the same filenames, this regex is added into DownloadManager and the GCP helpers.</p>
<p>Set up logging locally.</p>
<div class="highlight"><pre><span></span><code><span class="n">debug_fp</span> <span class="o">=</span> <span class="s1">&#39;../logs/EUMETSAT_download.txt&#39;</span>
<span class="n">log</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">set_up_logging</span><span class="p">(</span><span class="s1">&#39;EUMETSAT Processing&#39;</span><span class="p">,</span> <span class="n">debug_fp</span><span class="p">)</span>
</code></pre></div>
<h2 id="helper-utils">Helper utils<a class="headerlink" href="#helper-utils" title="Permanent link">&para;</a></h2>
<p>For local testing, this command downloads some files from the Google Cloud bucket:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># get test files from GCP - these are compressed</span>
<span class="c1"># !gsutil cp -r gs://solar-pv-nowcasting-data/satellite/EUMETSAT/SEVIRI_RSS/native/2019/10/01/00/04 ../data/raw</span>
</code></pre></div>
<h2 id="compress-downloaded-native-image-files">Compress downloaded native image files<a class="headerlink" href="#compress-downloaded-native-image-files" title="Permanent link">&para;</a></h2>
<p>Once files have been downloaded from the EUMETSAT API in some location, they need to be compressed and saved in a cloud storage bucket. </p>
<p>First, see which files have already been downloaded locally to test this functionality.  </p>
<div class="highlight"><pre><span></span><code><span class="n">full_native_filenames</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="s1">&#39;*.nat&#39;</span><span class="p">))</span>
<span class="n">full_native_filenames</span>
</code></pre></div>
<p>We will compress locally downloaded files here using <code>pbzip2</code><br />
On ubuntu: <code>sudo apt-get install -y pbzip2</code><br />
On mac: <code>brew install pbzip2</code>  </p>
<div class="highlight"><pre><span></span><code><span class="n">compress_downloaded_files</span><span class="p">(</span><span class="n">data_dir</span><span class="o">=</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">compressed_dir</span><span class="o">=</span><span class="n">compressed_dir</span><span class="p">)</span>
</code></pre></div>
<h2 id="syncing-files-to-gcp-storage">Syncing files to GCP Storage<a class="headerlink" href="#syncing-files-to-gcp-storage" title="Permanent link">&para;</a></h2>
<p>Compressed native files should be stored in a Google Cloud Storage Bucket. The folder structure follows the following convention:  </p>
<p><code>gs://solar-pv-nowcasting-data/satellite/EUMETSAT/SEVIRI_RSS/native/&lt;year&gt;/&lt;month&gt;/&lt;day&gt;/&lt;hour&gt;/&lt;minute&gt;/</code></p>
<div class="highlight"><pre><span></span><code><span class="c1"># sync downloaded files in compressed_dir to the bucket</span>
<span class="n">BUCKET_NAME</span> <span class="o">=</span> <span class="s2">&quot;solar-pv-nowcasting-data&quot;</span>
<span class="n">PREFIX</span> <span class="o">=</span> <span class="s2">&quot;satellite/EUMETSAT/SEVIRI_RSS/native/&quot;</span>
</code></pre></div>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../00_utils/" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Utilities
              </div>
            </div>
          </a>
        
        
          <a href="../02_reproj/" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Reprojection
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/vendor.0ac82a11.min.js"></script>
      <script src="../assets/javascripts/bundle.f81dfb4d.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}</script>
      
      <script>
        app = initialize({
          base: "..",
          features: ['header.autohide', 'navigation.tabs', 'navigation.instant', 'search.suggest'],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.4ac00218.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
        <script src="../javascripts/config.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>